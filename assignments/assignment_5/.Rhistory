title = "Local Moran’s I: Sanitation Violation Clusters",
subtitle = "High-High = Hot Spots  |  Low-Low = Cold Spots"
) +
theme_void() +
theme(
plot.title = element_text(face = "bold", size = 14),
plot.subtitle = element_text(color = "gray40")
)
hotspots <- fishnet %>%
filter(clusterType == "High-High") %>%
st_centroid()
fishnet$dist_to_hotspot <- as.numeric(
st_distance(fishnet_centroids, hotspots %>% st_union())
)
summary(fishnet$dist_to_hotspot)
cat("Calculated distance to nearest High-High cluster\n")
fishnet_model <- fishnet %>%
st_drop_geometry() %>%
as.data.frame() %>%
dplyr::select(uniqueID, countSanitation, nn_meanDist, dist_to_hotspot) %>%
tidyr::drop_na()
cat("✓ Modeling dataset ready with", nrow(fishnet_model), "observations\n")
model_pois <- glm(
countSanitation ~ nn_meanDist + dist_to_hotspot,
data = fishnet_model,
family = "poisson"
)
summary(model_pois)
dispersion <- sum(residuals(model_pois, type = "pearson")^2) /
model_pois$df.residual
cat("\nDispersion parameter:", round(dispersion, 2), "\n")
if (dispersion > 1.5) {
cat("⚠ Overdispersion detected — Negative Binomial model recommended.\n")
} else {
cat("✓ Dispersion acceptable for Poisson model.\n")
}
model_nb <- glm.nb(
countSanitation ~ nn_meanDist + dist_to_hotspot,
data = fishnet_model
)
summary(model_nb)
cat("\nModel Fit Comparison:\n")
cat("Poisson AIC:", round(AIC(model_pois), 2), "\n")
cat("NegBin  AIC:", round(AIC(model_nb), 2), "\n")
policeDistricts <- suppressMessages(
st_read(
"https://data.cityofchicago.org/api/geospatial/24zt-jpfn?method=export&format=GeoJSON",
quiet = TRUE
)
) |>
st_transform("ESRI:102271") |>
dplyr::select(District = dist_num)
fishnet <- st_join(fishnet, policeDistricts, join = st_within, left = TRUE) %>%
filter(!is.na(District))
cat("✓ Joined police districts:", length(unique(fishnet$District)), "\n")
fishnet_model <- fishnet %>%
st_drop_geometry() %>%
as.data.frame() %>%
dplyr::select(uniqueID, District, countSanitation, nn_meanDist, dist_to_hotspot) %>%
tidyr::drop_na()
cat("Data ready for LOGO CV with", nrow(fishnet_model), "observations\n")
districts <- unique(fishnet_model$District)
cv_results <- tibble()
cat("Running LOGO cross-validation across", length(districts), "districts...\n")
for (i in seq_along(districts)) {
test_district <- districts[i]
train_data <- fishnet_model %>% filter(District != test_district)
test_data  <- fishnet_model %>% filter(District == test_district)
model_cv <- glm.nb(countSanitation ~ nn_meanDist + dist_to_hotspot, data = train_data)
test_data <- test_data %>%
mutate(prediction = predict(model_cv, newdata = test_data, type = "response"))
mae  <- mean(abs(test_data$countSanitation - test_data$prediction))
rmse <- sqrt(mean((test_data$countSanitation - test_data$prediction)^2))
cv_results <- bind_rows(cv_results, tibble(
fold = i,
test_district = test_district,
n_test = nrow(test_data),
MAE = mae,
RMSE = rmse
))
cat("  Fold", i, "/", length(districts),
"- District", test_district,
"- MAE:", round(mae, 2),
"- RMSE:", round(rmse, 2), "\n")
}
cat("\nLOGO Cross-Validation complete\n")
cat("Mean MAE :", round(mean(cv_results$MAE), 2), "\n")
cat("Mean RMSE:", round(mean(cv_results$RMSE), 2), "\n")
cv_results %>%
arrange(desc(MAE)) %>%
kable(
digits = 2,
caption = "Leave-One-District-Out Cross-Validation Results"
) %>%
kable_styling(bootstrap_options = c("striped", "hover"))
fishnet_model$pred_2017 <- predict(model_nb, newdata = fishnet_model, type = "response")
cat("Generated in-sample predictions for 2017\n")
sanitation_2018 <- read_csv("data/Sanitation.csv") %>%
mutate(CreationDate = mdy(`Creation Date`),
Year = year(CreationDate)) %>%
filter(Year == 2018,
!is.na(Latitude), !is.na(Longitude)) %>%
st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326) %>%
st_transform('ESRI:102271')
cat("Loaded 2018 sanitation records:", nrow(sanitation_2018), "\n")
fishnet_2018 <- st_join(fishnet, sanitation_2018, join = st_contains) %>%
group_by(uniqueID) %>%
summarise(count2018 = n()) %>%
right_join(fishnet_model, by = "uniqueID") %>%
mutate(count2018 = ifelse(is.na(count2018), 0, count2018))
cat("Aggregated 2018 counts to fishnet grid\n")
fishnet_2018$pred_2018 <- predict(model_nb, newdata = fishnet_2018, type = "response")
fishnet_2018 <- fishnet_2018 %>%
mutate(error = count2018 - pred_2018)
mae_2018 <- mean(abs(fishnet_2018$error))
rmse_2018 <- sqrt(mean((fishnet_2018$error)^2))
cat("2018 Temporal Validation complete\n")
cat("MAE (2018):", round(mae_2018, 2), "\n")
cat("RMSE (2018):", round(rmse_2018, 2), "\n")
points2017 <- sanitation_sf %>%
st_coordinates() %>%
as.data.frame()
kde_2017 <- spatstat.geom::ppp(points2017$X, points2017$Y,
window = spatstat.geom::as.owin(st_union(chicagoBoundary)))
kde_density <- spatstat.explore::density.ppp(kde_2017, sigma = 1000) # bandwidth 1km
fishnet_2018$kde_pred <- raster::extract(raster::raster(kde_density),
st_coordinates(st_centroid(fishnet)))
kde_mae  <- mean(abs(fishnet_2018$count2018 - fishnet_2018$kde_pred), na.rm = TRUE)
kde_rmse <- sqrt(mean((fishnet_2018$count2018 - fishnet_2018$kde_pred)^2, na.rm = TRUE))
cat("KDE baseline complete\n")
cat("KDE MAE:", round(kde_mae, 2), "\n")
cat("KDE RMSE:", round(kde_rmse, 2), "\n")
ggplot() +
geom_sf(data = chicagoBoundary, fill = "gray95", color = "white") +
geom_sf(data = fishnet_2018, aes(fill = error), color = NA) +
scale_fill_gradient2(
low = "#2c7bb6",
mid = "white",
high = "#d7191c",
midpoint = 0,
name = "Prediction Error"
) +
labs(
title = "Prediction Errors for 2018 (Observed - Predicted)",
subtitle = "Negative Binomial Model",
caption = "Blue = Overprediction, Red = Underprediction"
) +
theme_void() +
theme(
plot.title = element_text(face = "bold", size = 14),
plot.subtitle = element_text(color = "gray40")
)
crime_2018 <- read_csv("https://data.cityofchicago.org/resource/3i3m-jwuy.csv")
crime_2018_burg <- crime_2018 %>%
filter(primary_type == "BURGLARY",
description == "FORCIBLE ENTRY",
!is.na(longitude), !is.na(latitude)) %>%
mutate(year = year(as_date(date)))
cat("2018 burglary (FORCIBLE ENTRY) incidents:",
nrow(crime_2018_burg), "\n")
crime_2018_sf <- st_as_sf(
crime_2018_burg,
coords = c("longitude", "latitude"),
crs = 4326
) %>%
st_transform(st_crs(fishnet))
counts_crime_2018 <- st_join(fishnet, crime_2018_sf, join = st_contains) %>%
st_drop_geometry() %>%
count(uniqueID, name = "countCrime2018")
fishnet_crime_2018 <- fishnet %>%
left_join(counts_crime_2018, by = "uniqueID") %>%
mutate(countCrime2018 = replace_na(countCrime2018, 0))
fishnet_crime_2018$predCrime <- predict(
model_nb,
newdata = fishnet_crime_2018 %>% st_drop_geometry(),
type = "response"
)
fishnet_crime_2018 <- fishnet_crime_2018 %>%
mutate(error = countCrime2018 - predCrime)
mae_crime <- mean(abs(fishnet_crime_2018$error))
rmse_crime <- sqrt(mean((fishnet_crime_2018$error)^2))
cat("2018 Burglary Temporal Validation → MAE:", round(mae_crime, 2),
" RMSE:", round(rmse_crime, 2), "\n")
ggplot() +
geom_sf(data = chicagoBoundary, fill = "gray95", color = "white") +
geom_sf(data = fishnet_crime_2018, aes(fill = error), color = NA) +
scale_fill_gradient2(low = "#2c7bb6", mid = "white", high = "#d7191c",
midpoint = 0, name = "Error (Obs - Pred)") +
labs(title = "2018 Burglary (FORCIBLE ENTRY) Prediction Errors",
subtitle = "Predicted using 2017 Sanitation Model",
caption = "Blue = Overprediction, Red = Underprediction") +
theme_void() +
theme(
plot.title = element_text(face = "bold", size = 14),
plot.subtitle = element_text(color = "gray40")
)
knitr::opts_chunk$set(
echo = TRUE,
warning = FALSE,
message = FALSE,
cache = TRUE
)
library(tidyverse)
library(lubridate)
library(sf)
library(tigris)
library(tidycensus)
library(riem)
library(viridis)
library(gridExtra)
library(knitr)
library(kableExtra)
library(here)
options(scipen = 999)
library(tidyverse)
library(lubridate)
library(sf)
library(tigris)
library(tidycensus)
library(riem)
library(viridis)
library(gridExtra)
library(knitr)
library(kableExtra)
library(here)
options(scipen = 999)
knitr::opts_chunk$set(
echo = TRUE,
warning = FALSE,
message = FALSE,
cache = TRUE
)
plotTheme <- theme(
plot.title = element_text(size = 14, face = "bold"),
axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
axis.text.y = element_text(size = 10)
)
mapTheme <- theme(
plot.title = element_text(size = 14, face = "bold"),
axis.text = element_blank(),
axis.ticks = element_blank(),
panel.background = element_blank()
)
indego <- read_csv(here("data/indego-trips-2024-q2.csv"))
setwd("~/GitHub/portfolio-setup-lluluciano0505/assignments/assignment_5")
indego <- read_csv(here("data/indego-trips-2024-q2.csv"))
indego <- read_csv("data/indego-trips-2024-q2.csv")
glimpse(indego)
indego <- read_csv("data/indego-trips-2024-q2.csv")
indego <- indego %>%
mutate(
start_datetime = mdy_hm(start_time),
end_datetime   = mdy_hm(end_time),
interval60     = floor_date(start_datetime, "hour"),
week           = week(interval60),
month          = month(interval60, label = TRUE),
dotw           = wday(interval60, label = TRUE),
hour           = hour(interval60),
date           = as.Date(interval60),
weekend        = ifelse(dotw %in% c("Sat", "Sun"), 1, 0),
rush_hour      = ifelse(hour %in% c(7,8,9,16,17,18), 1, 0)
)
philly_census <- get_acs(
geography = "tract",
variables = c(
"B01003_001",
"B19013_001",
"B08301_001",
"B08301_010",
"B02001_002",
"B25077_001"
),
state = "PA",
county = "Philadelphia",
year = 2022,
geometry = TRUE,
output = "wide"
) %>%
rename(
Total_Pop  = B01003_001E,
Med_Inc    = B19013_001E,
Total_Comm = B08301_001E,
Transit    = B08301_010E,
White      = B02001_002E
) %>%
mutate(
PctTransit = 100 * Transit / Total_Comm,
PctWhite   = 100 * White   / Total_Pop
) %>%
st_transform(4326)
stations_sf <- indego %>%
distinct(start_station, start_lat, start_lon) %>%
filter(!is.na(start_lat)) %>%
st_as_sf(coords = c("start_lon", "start_lat"), crs = 4326)
stations_census <- st_join(stations_sf, philly_census) %>%
st_drop_geometry() %>%
select(start_station, Med_Inc, PctTransit, PctWhite, Total_Pop)
stations_sf <- indego %>%
distinct(start_station, start_lat, start_lon) %>%
filter(!is.na(start_lat)) %>%
st_as_sf(coords = c("start_lon", "start_lat"), crs = 4326)
stations_census <- st_join(stations_sf, philly_census) %>%
st_drop_geometry() %>%
select(start_station, Med_Inc, PctTransit, PctWhite, Total_Pop)
valid_stations <- stations_census %>%
filter(!is.na(Med_Inc)) %>%
pull(start_station)
indego_census <- indego %>%
filter(start_station %in% valid_stations) %>%
left_join(stations_census, by = "start_station")
weather_raw <- riem_measures(
station = "PHL",
date_start = "2024-04-01",
date_end   = "2024-06-30"
)
weather_complete <- weather_raw %>%
mutate(
interval60     = floor_date(valid, "hour"),
Temperature    = tmpf,
Precipitation  = ifelse(is.na(p01i), 0, p01i),
Wind_Speed     = sknt
) %>%
select(interval60, Temperature, Precipitation, Wind_Speed) %>%
distinct() %>%
complete(interval60 = seq(min(interval60), max(interval60), "hour")) %>%
fill(Temperature, Precipitation, Wind_Speed, .direction = "down")
trips_panel <- indego_census %>%
group_by(interval60, start_station) %>%
summarize(
Trip_Count = n(),
start_lat  = first(start_lat),
start_lon  = first(start_lon),
Med_Inc    = first(Med_Inc),
PctTransit = first(PctTransit),
PctWhite   = first(PctWhite),
Total_Pop  = first(Total_Pop),
.groups    = "drop"
)
View(mapTheme)
study_panel <- expand_grid(
interval60    = unique(trips_panel$interval60),
start_station = unique(trips_panel$start_station)
) %>%
left_join(trips_panel, by = c("interval60", "start_station")) %>%
mutate(Trip_Count = replace_na(Trip_Count, 0)) %>%
mutate(
week    = week(interval60),
month   = month(interval60, label = TRUE),
dotw    = wday(interval60, label = TRUE),
hour    = hour(interval60),
date    = as.Date(interval60),
weekend = ifelse(dotw %in% c("Sat","Sun"), 1, 0),
rush_hour = ifelse(hour %in% c(7,8,9,16,17,18), 1, 0)
) %>%
left_join(weather_complete, by = "interval60")
study_panel <- study_panel %>%
arrange(start_station, interval60) %>%
group_by(start_station) %>%
mutate(
lag1Hour  = lag(Trip_Count, 1),
lag3Hours = lag(Trip_Count, 3),
lag1day   = lag(Trip_Count, 24)
) %>%
ungroup()
study_panel_complete <- study_panel %>%
filter(!is.na(lag1day))
week_cut <- floor(quantile(study_panel_complete$week, 0.75))
train_full <- study_panel_complete %>% filter(week <= week_cut)
test_full  <- study_panel_complete %>% filter(week > week_cut)
early_stations <- train_full %>% filter(Trip_Count > 0) %>% pull(start_station)
late_stations  <- test_full  %>% filter(Trip_Count > 0) %>% pull(start_station)
common_stations <- intersect(early_stations, late_stations)
train <- train_full %>% filter(start_station %in% common_stations)
test  <- test_full  %>% filter(start_station %in% common_stations)
train <- train %>% mutate(dotw_simple = factor(dotw))
test  <- test  %>% mutate(dotw_simple = factor(dotw))
contrasts(train$dotw_simple) <- contr.treatment(7)
contrasts(test$dotw_simple)  <- contr.treatment(7)
model1 <- lm(
Trip_Count ~ as.factor(hour) + dotw_simple + Temperature + Precipitation,
data = train
)
model2 <- lm(
Trip_Count ~ as.factor(hour) + dotw_simple + Temperature + Precipitation +
lag1Hour + lag3Hours + lag1day,
data = train
)
model3 <- lm(
Trip_Count ~ as.factor(hour) + dotw_simple + Temperature + Precipitation +
lag1Hour + lag3Hours + lag1day +
Med_Inc + PctTransit + PctWhite + Total_Pop,
data = train
)
model4 <- lm(
Trip_Count ~ as.factor(hour) + dotw_simple + Temperature + Precipitation +
lag1Hour + lag3Hours + lag1day +
Med_Inc + PctTransit + PctWhite +
as.factor(start_station),
data = train
)
model5 <- lm(
Trip_Count ~ as.factor(hour) + dotw_simple + Temperature + Precipitation +
lag1Hour + lag3Hours + lag1day +
rush_hour + as.factor(month) +
Med_Inc + PctTransit + PctWhite +
as.factor(start_station) +
rush_hour * weekend,
data = train
)
test <- test %>%
mutate(
pred1 = predict(model1, .),
pred2 = predict(model2, .),
pred3 = predict(model3, .),
pred4 = predict(model4, .),
pred5 = predict(model5, .)
)
mae_results <- tibble(
Model = c(
"1. Time + Weather",
"2. + Lags",
"3. + Demographics",
"4. + Station FE",
"5. + Rush/Month Interaction"
),
MAE = c(
mean(abs(test$Trip_Count - test$pred1)),
mean(abs(test$Trip_Count - test$pred2)),
mean(abs(test$Trip_Count - test$pred3)),
mean(abs(test$Trip_Count - test$pred4)),
mean(abs(test$Trip_Count - test$pred5))
)
)
kable(mae_results, digits = 2,
caption = "Model Comparison (MAE)") %>%
kable_styling(bootstrap_options = c("striped", "hover"))
summary(model1)
summary(model2)
summary(model3)
summary(model4)
summary(model5)
test <- test %>%
mutate(
pred1 = predict(model1, .),
pred2 = predict(model2, .),
pred3 = predict(model3, .),
pred4 = predict(model4, .),
pred5 = predict(model5, .)
)
test <- test %>%
mutate(
pred1 = predict(model1, .),
pred2 = predict(model2, .),
pred3 = predict(model3, .),
pred4 = predict(model4, .),
pred5 = predict(model5, .)
)
model_performance <- tibble(
Model = c("Model 1", "Model 2", "Model 3", "Model 4", "Model 5"),
RMSE = c(
sqrt(mean((test$Trip_Count - test$pred1)^2)),
sqrt(mean((test$Trip_Count - test$pred2)^2)),
sqrt(mean((test$Trip_Count - test$pred3)^2)),
sqrt(mean((test$Trip_Count - test$pred4)^2)),
sqrt(mean((test$Trip_Count - test$pred5)^2))
)
) %>%
arrange(RMSE)
model_performance %>%
kable("html", digits = 2, caption = "Model Performance on Test Set") %>%
kable_styling(full_width = FALSE, position = "center")
### Model Comparison
```{r}
### Model Comparison
test <- test %>%
mutate(
pred1 = predict(model1, newdata = test),
pred2 = predict(model2, newdata = test),
pred3 = predict(model3, newdata = test),
pred4 = predict(model4, newdata = test),
pred5 = predict(model5, newdata = test)
)
rmse <- function(obs, pred) {
sqrt(mean((obs - pred)^2, na.rm = TRUE))
}
model_performance <- tibble(
Model = c("Model 1", "Model 2", "Model 3", "Model 4", "Model 5"),
RMSE = c(
rmse(test$Trip_Count, test$pred1),
rmse(test$Trip_Count, test$pred2),
rmse(test$Trip_Count, test$pred3),
rmse(test$Trip_Count, test$pred4),
rmse(test$Trip_Count, test$pred5)
)
) %>%
arrange(RMSE)
model_performance %>%
kable("html", digits = 2, caption = "Model Performance on Test Set") %>%
kable_styling(full_width = FALSE, position = "center")
summary(is.na(test$pred1))
summary(is.na(test$pred2))
summary(is.na(test$pred1))
summary(is.na(test$pred2))
summary(is.na(test$pred3))
summary(is.na(test$pred4))
summary(is.na(test$pred5))
test %>%
summarise(
na_Med_Inc    = sum(is.na(Med_Inc)),
na_PctTransit = sum(is.na(PctTransit)),
na_PctWhite   = sum(is.na(PctWhite))
)
