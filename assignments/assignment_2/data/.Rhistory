) |>
transmute(
GEOID = as.character(GEOID),
child_5_17 = male_5_9E + male_10_14E + male_15_17E +
fem_5_9E  + fem_10_14E  + fem_15_17E
)
phl_access <- phl_access |>
mutate(GEOID = as.character(GEOID)) |>
left_join(phl_demo, by = "GEOID")
# 6) 打标：覆盖<=10% 视作教育荒漠；儿童人数用城市四分位数上四分位做“高儿童”
stopifnot("child_5_17" %in% names(phl_access))
q_child <- quantile(phl_access$child_5_17, 0.75, na.rm = TRUE)
phl_access <- phl_access |>
mutate(
edu_desert    = coverage_pct <= 10,
high_children = child_5_17 >= q_child,
priority      = edu_desert & high_children
)
# 7) 打印关键统计
res_summary <- phl_access |>
st_drop_geometry() |>
summarize(
n_tracts          = n(),
n_desert          = sum(edu_desert, na.rm = TRUE),
pct_desert        = round(100 * n_desert / n_tracts, 1),
n_priority        = sum(priority, na.rm = TRUE),
children_desert   = sum(child_5_17[edu_desert], na.rm = TRUE),
children_priority = sum(child_5_17[priority],  na.rm = TRUE),
mean_coverage     = round(mean(coverage_pct, na.rm = TRUE), 1),
median_coverage   = round(median(coverage_pct, na.rm = TRUE), 1)
)
print(res_summary)
# 8) 列出前 10 个“优先” tract（儿童最多且覆盖低）
top_priority <- phl_access |>
st_drop_geometry() |>
filter(priority) |>
arrange(desc(child_5_17)) |>
transmute(GEOID, coverage_pct = round(coverage_pct, 1), child_5_17) |>
head(10)
print(top_priority)
options(tigris_use_cache = TRUE, tigris_class = "sf")
acs_year   <- 2022
crs_feet   <- 2272
half_mile  <- 0.5 * 5280
stopifnot(inherits(schools, "sf"), st_crs(schools)$epsg == crs_feet)
# 1) 仅保留“服务小学”的学校
#    规则：grade_org 含 PREK/K 到 5/6；或 grade_level 含 ELEMENTARY
elem_schools <- schools |>
mutate(
go = toupper(trimws(as.character(grade_org))),
gl = toupper(trimws(as.character(grade_level))),
serves_elem = grepl("PREK|K|K-|K–|K TO|K/|^K$|^PREK", go) |
grepl("^-?0?5|^-?0?6|-5|-6", go) |
grepl("ELEMENTARY", gl)
) |>
filter(serves_elem) |>
select(school_name, type_specific, grade_org, grade_level)
# 2) 费城 tracts（2272）
phl_tracts <- tracts(state = "PA", county = "Philadelphia", cb = TRUE, year = 2023) |>
st_transform(crs_feet) |>
select(GEOID)
# 3) 小学 0.5 英里缓冲 → 合并覆盖面
elem_buf <- elem_schools |>
st_buffer(half_mile) |>
st_union() |>
st_make_valid()
# 4) 计算每个 tract 的覆盖比例（按面积）
phl_tracts <- phl_tracts |>
mutate(tract_area_ft2 = as.numeric(st_area(geometry)))
covered_parts <- suppressWarnings(st_intersection(phl_tracts, elem_buf))
cover_by_tract <- covered_parts |>
mutate(part_area_ft2 = as.numeric(st_area(geometry))) |>
st_drop_geometry() |>
group_by(GEOID) |>
summarize(covered_area_ft2 = sum(part_area_ft2), .groups = "drop")
phl_access_elem <- phl_tracts |>
left_join(cover_by_tract, by = "GEOID") |>
mutate(
covered_area_ft2 = ifelse(is.na(covered_area_ft2), 0, covered_area_ft2),
coverage_pct = pmin(100 * covered_area_ft2 / tract_area_ft2, 100)
)
# 5) 叠加 5–17 岁人口
vars_children <- c(
male_5_9="B01001_004", male_10_14="B01001_005", male_15_17="B01001_006",
fem_5_9 ="B01001_028", fem_10_14 ="B01001_029", fem_15_17 ="B01001_030"
)
phl_kids <- get_acs(
geography = "tract", state = "PA", county = "Philadelphia",
variables = vars_children, survey = "acs5", year = acs_year, output = "wide"
) |>
transmute(
GEOID = as.character(GEOID),
child_5_17 = male_5_9E + male_10_14E + male_15_17E +
fem_5_9E  + fem_10_14E  + fem_15_17E
)
phl_access_elem <- phl_access_elem |>
mutate(GEOID = as.character(GEOID)) |>
left_join(phl_kids, by = "GEOID")
# 6) 标记教育荒漠与优先片区（阈值可调）
q_child <- quantile(phl_access_elem$child_5_17, 0.75, na.rm = TRUE)
phl_access_elem <- phl_access_elem |>
mutate(
edu_desert    = coverage_pct <= 10,       # 小学步行覆盖 ≤10%
high_children = child_5_17 >= q_child,    # 儿童人数位于上四分位
priority      = edu_desert & high_children
)
# 7) 汇总
elem_summary <- phl_access_elem |>
st_drop_geometry() |>
summarize(
tracts      = n(),
deserts     = sum(edu_desert, na.rm = TRUE),
pct_deserts = round(100 * deserts / tracts, 1),
priority_n  = sum(priority, na.rm = TRUE),
kids_desert = sum(child_5_17[edu_desert], na.rm = TRUE)
)
print(elem_summary)
# 8) 地图：覆盖率 + 小学点 + 优先片区边框
ggplot() +
geom_sf(data = phl_access_elem, aes(fill = coverage_pct), color = "white", size = 0.15) +
geom_sf(data = elem_schools, shape = 21, fill = "black", color = "white", size = 1.2, alpha = 0.85) +
geom_sf(data = phl_access_elem |> filter(priority), fill = NA, color = "#D62728", linewidth = 0.9) +
scale_fill_viridis_c(
name = "Elem. buffer coverage",
labels = label_percent(accuracy = 1, scale = 1),
limits = c(0, 100), na.value = "grey90", option = "viridis"
) +
labs(
title = "Philadelphia Elementary School Walk Access (0.5 mile)",
subtitle = "Priority tracts: high child counts with ≤10% elementary coverage",
caption = "Sources: OpenDataPhilly School Facilities; ACS 2022 (tidycensus); TIGER/Line tracts"
) +
theme_void() +
theme(
legend.position = "right",
legend.title = element_text(face = "bold"),
plot.title    = element_text(face = "bold")
)
options(tigris_use_cache = TRUE, tigris_class = "sf")
acs_year   <- 2022
crs_feet   <- 2272
half_mile  <- 0.5 * 5280
stopifnot(inherits(schools, "sf"), st_crs(schools)$epsg == crs_feet)
elem_schools <- schools |>
mutate(
go = toupper(trimws(as.character(grade_org))),
gl = toupper(trimws(as.character(grade_level))),
serves_elem = grepl("PREK|K|K-|K–|K TO|K/|^K$|^PREK", go) |
grepl("^-?0?5|^-?0?6|-5|-6", go) |
grepl("ELEMENTARY", gl)
) |>
filter(serves_elem) |>
select(school_name, type_specific, grade_org, grade_level)
phl_tracts <- tracts(state = "PA", county = "Philadelphia", cb = TRUE, year = 2023) |>
st_transform(crs_feet) |>
select(GEOID)
elem_buf <- elem_schools |>
st_buffer(half_mile) |>
st_union() |>
st_make_valid()
phl_tracts <- phl_tracts |>
mutate(tract_area_ft2 = as.numeric(st_area(geometry)))
covered_parts <- suppressWarnings(st_intersection(phl_tracts, elem_buf))
cover_by_tract <- covered_parts |>
mutate(part_area_ft2 = as.numeric(st_area(geometry))) |>
st_drop_geometry() |>
group_by(GEOID) |>
summarize(covered_area_ft2 = sum(part_area_ft2), .groups = "drop")
phl_access_elem <- phl_tracts |>
left_join(cover_by_tract, by = "GEOID") |>
mutate(
covered_area_ft2 = ifelse(is.na(covered_area_ft2), 0, covered_area_ft2),
coverage_pct = pmin(100 * covered_area_ft2 / tract_area_ft2, 100)
)
vars_children <- c(
male_5_9="B01001_004", male_10_14="B01001_005",
fem_5_9 ="B01001_028", fem_10_14 ="B01001_029"
)
phl_kids <- get_acs(
geography = "tract", state = "PA", county = "Philadelphia",
variables = vars_children, survey = "acs5", year = acs_year, output = "wide"
) |>
transmute(
GEOID = as.character(GEOID),
child_5_14 = male_5_9E + male_10_14E +
fem_5_9E  + fem_10_14E
)
phl_access_elem <- phl_access_elem |>
mutate(GEOID = as.character(GEOID)) |>
left_join(phl_kids, by = "GEOID")
q_child <- quantile(phl_access_elem$child_5_17, 0.75, na.rm = TRUE)
phl_access_elem <- phl_access_elem |>
mutate(
edu_desert    = coverage_pct <= 10,
high_children = child_5_14 >= q_child,
priority      = edu_desert & high_children
)
elem_summary <- phl_access_elem |>
st_drop_geometry() |>
summarize(
tracts      = n(),
deserts     = sum(edu_desert, na.rm = TRUE),
pct_deserts = round(100 * deserts / tracts, 1),
priority_n  = sum(priority, na.rm = TRUE),
kids_desert = sum(child_5_14[edu_desert], na.rm = TRUE)
)
print(elem_summary)
ggplot() +
geom_sf(data = phl_access_elem, aes(fill = coverage_pct), color = "white", size = 0.15) +
geom_sf(data = elem_schools, shape = 21, fill = "black", color = "white", size = 1.2, alpha = 0.85) +
geom_sf(data = phl_access_elem |> filter(priority), fill = NA, color = "#D62728", linewidth = 0.9) +
scale_fill_viridis_c(
name = "Elem. buffer coverage",
labels = label_percent(accuracy = 1, scale = 1),
limits = c(0, 100), na.value = "grey90", option = "viridis"
) +
labs(
title = "Philadelphia Elementary School Walk Access (0.5 mile)",
subtitle = "Priority tracts: high child counts with ≤10% elementary coverage",
caption = "Sources: OpenDataPhilly School Facilities; ACS 2022 (tidycensus); TIGER/Line tracts"
) +
theme_void() +
theme(
legend.position = "right",
legend.title = element_text(face = "bold"),
plot.title    = element_text(face = "bold")
)
phl_access_elem <- phl_access_elem |>
mutate(GEOID = as.character(GEOID)) |>
left_join(phl_kids, by = "GEOID")
q_child <- quantile(phl_access_elem$child_5_14, 0.75, na.rm = TRUE)
phl_access_elem <- phl_access_elem |>
mutate(
edu_desert    = coverage_pct <= 10,
high_children = child_5_14 >= q_child,
priority      = edu_desert & high_children
)
options(tigris_use_cache = TRUE, tigris_class = "sf")
acs_year   <- 2022
crs_feet   <- 2272
half_mile  <- 0.5 * 5280
stopifnot(inherits(schools, "sf"), st_crs(schools)$epsg == crs_feet)
elem_schools <- schools |>
mutate(
go = toupper(trimws(as.character(grade_org))),
gl = toupper(trimws(as.character(grade_level))),
serves_elem = grepl("PREK|K|K-|K–|K TO|K/|^K$|^PREK", go) |
grepl("^-?0?5|^-?0?6|-5|-6", go) |
grepl("ELEMENTARY", gl)
) |>
filter(serves_elem) |>
select(school_name, type_specific, grade_org, grade_level)
phl_tracts <- tracts(state = "PA", county = "Philadelphia", cb = TRUE, year = 2023) |>
st_transform(crs_feet) |>
select(GEOID)
elem_buf <- elem_schools |>
st_buffer(half_mile) |>
st_union() |>
st_make_valid()
phl_tracts <- phl_tracts |>
mutate(tract_area_ft2 = as.numeric(st_area(geometry)))
covered_parts <- suppressWarnings(st_intersection(phl_tracts, elem_buf))
cover_by_tract <- covered_parts |>
mutate(part_area_ft2 = as.numeric(st_area(geometry))) |>
st_drop_geometry() |>
group_by(GEOID) |>
summarize(covered_area_ft2 = sum(part_area_ft2), .groups = "drop")
phl_access_elem <- phl_tracts |>
left_join(cover_by_tract, by = "GEOID") |>
mutate(
covered_area_ft2 = ifelse(is.na(covered_area_ft2), 0, covered_area_ft2),
coverage_pct = pmin(100 * covered_area_ft2 / tract_area_ft2, 100)
)
vars_children <- c(
male_5_9="B01001_004", male_10_14="B01001_005",
fem_5_9 ="B01001_028", fem_10_14 ="B01001_029"
)
phl_kids <- get_acs(
geography = "tract", state = "PA", county = "Philadelphia",
variables = vars_children, survey = "acs5", year = acs_year, output = "wide"
) |>
transmute(
GEOID = as.character(GEOID),
child_5_14 = male_5_9E + male_10_14E +
fem_5_9E  + fem_10_14E
)
phl_access_elem <- phl_access_elem |>
mutate(GEOID = as.character(GEOID)) |>
left_join(phl_kids, by = "GEOID")
q_child <- quantile(phl_access_elem$child_5_14, 0.75, na.rm = TRUE)
phl_access_elem <- phl_access_elem |>
mutate(
edu_desert    = coverage_pct <= 10,
high_children = child_5_14 >= q_child,
priority      = edu_desert & high_children
)
elem_summary <- phl_access_elem |>
st_drop_geometry() |>
summarize(
tracts      = n(),
deserts     = sum(edu_desert, na.rm = TRUE),
pct_deserts = round(100 * deserts / tracts, 1),
priority_n  = sum(priority, na.rm = TRUE),
kids_desert = sum(child_5_14[edu_desert], na.rm = TRUE)
)
print(elem_summary)
ggplot() +
geom_sf(data = phl_access_elem, aes(fill = coverage_pct), color = "white", size = 0.15) +
geom_sf(data = elem_schools, shape = 21, fill = "black", color = "white", size = 1.2, alpha = 0.85) +
geom_sf(data = phl_access_elem |> filter(priority), fill = NA, color = "#D62728", linewidth = 0.9) +
scale_fill_viridis_c(
name = "Elem. buffer coverage",
labels = label_percent(accuracy = 1, scale = 1),
limits = c(0, 100), na.value = "grey90", option = "viridis"
) +
labs(
title = "Philadelphia Elementary School Walk Access (0.5 mile)",
subtitle = "Priority tracts: high child counts with ≤10% elementary coverage",
caption = "Sources: OpenDataPhilly School Facilities; ACS 2022 (tidycensus); TIGER/Line tracts"
) +
theme_void() +
theme(
legend.position = "right",
legend.title = element_text(face = "bold"),
plot.title    = element_text(face = "bold")
)
acs_year   <- 2022
crs_feet   <- 2272
half_mile  <- 0.25 * 5280
stopifnot(inherits(schools, "sf"), st_crs(schools)$epsg == crs_feet)
elem_schools <- schools |>
mutate(
go = toupper(trimws(as.character(grade_org))),
gl = toupper(trimws(as.character(grade_level))),
serves_elem = grepl("PREK|K|K-|K–|K TO|K/|^K$|^PREK", go) |
grepl("^-?0?5|^-?0?6|-5|-6", go) |
grepl("ELEMENTARY", gl)
) |>
filter(serves_elem) |>
select(school_name, type_specific, grade_org, grade_level)
phl_tracts <- tracts(state = "PA", county = "Philadelphia", cb = TRUE, year = 2023) |>
st_transform(crs_feet) |>
select(GEOID)
elem_buf <- elem_schools |>
st_buffer(half_mile) |>
st_union() |>
st_make_valid()
phl_tracts <- phl_tracts |>
mutate(tract_area_ft2 = as.numeric(st_area(geometry)))
covered_parts <- suppressWarnings(st_intersection(phl_tracts, elem_buf))
cover_by_tract <- covered_parts |>
mutate(part_area_ft2 = as.numeric(st_area(geometry))) |>
st_drop_geometry() |>
group_by(GEOID) |>
summarize(covered_area_ft2 = sum(part_area_ft2), .groups = "drop")
phl_access_elem <- phl_tracts |>
left_join(cover_by_tract, by = "GEOID") |>
mutate(
covered_area_ft2 = ifelse(is.na(covered_area_ft2), 0, covered_area_ft2),
coverage_pct = pmin(100 * covered_area_ft2 / tract_area_ft2, 100)
)
vars_children <- c(
male_5_9="B01001_004", male_10_14="B01001_005",
fem_5_9 ="B01001_028", fem_10_14 ="B01001_029"
)
phl_kids <- get_acs(
geography = "tract", state = "PA", county = "Philadelphia",
variables = vars_children, survey = "acs5", year = acs_year, output = "wide"
) |>
transmute(
GEOID = as.character(GEOID),
child_5_14 = male_5_9E + male_10_14E +
fem_5_9E  + fem_10_14E
)
phl_access_elem <- phl_access_elem |>
mutate(GEOID = as.character(GEOID)) |>
left_join(phl_kids, by = "GEOID")
q_child <- quantile(phl_access_elem$child_5_14, 0.75, na.rm = TRUE)
phl_access_elem <- phl_access_elem |>
mutate(
edu_desert    = coverage_pct <= 10,
high_children = child_5_14 >= q_child,
priority      = edu_desert & high_children
)
elem_summary <- phl_access_elem |>
st_drop_geometry() |>
summarize(
tracts      = n(),
deserts     = sum(edu_desert, na.rm = TRUE),
pct_deserts = round(100 * deserts / tracts, 1),
priority_n  = sum(priority, na.rm = TRUE),
kids_desert = sum(child_5_14[edu_desert], na.rm = TRUE)
)
print(elem_summary)
ggplot() +
geom_sf(data = phl_access_elem, aes(fill = coverage_pct), color = "white", size = 0.15) +
geom_sf(data = elem_schools, shape = 21, fill = "black", color = "white", size = 1.2, alpha = 0.85) +
geom_sf(data = phl_access_elem |> filter(priority), fill = NA, color = "#D62728", linewidth = 0.9) +
scale_fill_viridis_c(
name = "Elem. buffer coverage",
labels = label_percent(accuracy = 1, scale = 1),
limits = c(0, 100), na.value = "grey90", option = "viridis"
) +
labs(
title = "Philadelphia Elementary School Walk Access (0.5 mile)",
subtitle = "Priority tracts: high child counts with ≤10% elementary coverage",
caption = "Sources: OpenDataPhilly School Facilities; ACS 2022 (tidycensus); TIGER/Line tracts"
) +
theme_void() +
theme(
legend.position = "right",
legend.title = element_text(face = "bold"),
plot.title    = element_text(face = "bold")
)
phl_access_elem |>
st_drop_geometry() |>
filter(priority) |>
select(GEOID, coverage_pct, child_5_14) |>
arrange(desc(child_5_14))
acs_year   <- 2022
crs_feet   <- 2272
half_mile  <- 0.25 * 5280
stopifnot(inherits(schools, "sf"), st_crs(schools)$epsg == crs_feet)
elem_schools <- schools |>
mutate(
go = toupper(trimws(as.character(grade_org))),
gl = toupper(trimws(as.character(grade_level))),
serves_elem = grepl("PREK|K|K-|K–|K TO|K/|^K$|^PREK", go) |
grepl("^-?0?5|^-?0?6|-5|-6", go) |
grepl("ELEMENTARY", gl)
) |>
filter(serves_elem) |>
select(school_name, type_specific, grade_org, grade_level)
phl_tracts <- tracts(state = "PA", county = "Philadelphia", cb = TRUE, year = 2023) |>
st_transform(crs_feet) |>
select(GEOID)
elem_buf <- elem_schools |>
st_buffer(half_mile) |>
st_union() |>
st_make_valid()
phl_tracts <- phl_tracts |>
mutate(tract_area_ft2 = as.numeric(st_area(geometry)))
covered_parts <- suppressWarnings(st_intersection(phl_tracts, elem_buf))
cover_by_tract <- covered_parts |>
mutate(part_area_ft2 = as.numeric(st_area(geometry))) |>
st_drop_geometry() |>
group_by(GEOID) |>
summarize(covered_area_ft2 = sum(part_area_ft2), .groups = "drop")
phl_access_elem <- phl_tracts |>
left_join(cover_by_tract, by = "GEOID") |>
mutate(
covered_area_ft2 = ifelse(is.na(covered_area_ft2), 0, covered_area_ft2),
coverage_pct = pmin(100 * covered_area_ft2 / tract_area_ft2, 100)
)
vars_children <- c(
male_5_9="B01001_004", male_10_14="B01001_005",
fem_5_9 ="B01001_028", fem_10_14 ="B01001_029"
)
phl_kids <- get_acs(
geography = "tract", state = "PA", county = "Philadelphia",
variables = vars_children, survey = "acs5", year = acs_year, output = "wide"
) |>
transmute(
GEOID = as.character(GEOID),
child_5_14 = male_5_9E + male_10_14E +
fem_5_9E  + fem_10_14E
)
phl_access_elem <- phl_access_elem |>
mutate(GEOID = as.character(GEOID)) |>
left_join(phl_kids, by = "GEOID")
q_child <- quantile(phl_access_elem$child_5_14, 0.75, na.rm = TRUE)
phl_access_elem <- phl_access_elem |>
mutate(
edu_desert    = coverage_pct <= 10,
high_children = child_5_14 >= q_child,
priority      = edu_desert & high_children
)
elem_summary <- phl_access_elem |>
st_drop_geometry() |>
summarize(
tracts      = n(),
deserts     = sum(edu_desert, na.rm = TRUE),
pct_deserts = round(100 * deserts / tracts, 1),
priority_n  = sum(priority, na.rm = TRUE),
kids_desert = sum(child_5_14[edu_desert], na.rm = TRUE)
)
print(elem_summary)
ggplot() +
geom_sf(data = phl_access_elem, aes(fill = coverage_pct), color = "white", size = 0.15) +
geom_sf(data = elem_schools, shape = 21, fill = "black", color = "white", size = 1.2, alpha = 0.85) +
geom_sf(data = phl_access_elem |> filter(priority), fill = NA, color = "#D62728", linewidth = 0.9) +
scale_fill_viridis_c(
name = "Elem. buffer coverage",
labels = label_percent(accuracy = 1, scale = 1),
limits = c(0, 100), na.value = "grey90", option = "viridis"
) +
labs(
title = "Philadelphia Elementary School Walk Access (0.5 mile)",
subtitle = "Priority tracts: high child counts with ≤10% elementary coverage",
caption = "Sources: OpenDataPhilly School Facilities; ACS 2022 (tidycensus); TIGER/Line tracts"
) +
theme_void() +
theme(
legend.position = "right",
legend.title = element_text(face = "bold"),
plot.title    = element_text(face = "bold")
)
phl_access_elem |>
st_drop_geometry() |>
filter(priority) |>
select(GEOID, coverage_pct, child_5_14) |>
arrange(desc(child_5_14))
