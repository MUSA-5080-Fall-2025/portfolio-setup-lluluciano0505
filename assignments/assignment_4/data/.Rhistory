cat("✓ 311 sanitation records for 2017:", nrow(sanitation_sf), "\n")
# 1.6 Quick spatial plot: where are the violations located?
ggplot() +
geom_sf(data = chicagoBoundary, fill = "gray95", color = "gray60") +
geom_sf(data = sanitation_sf, color = "#d62828", size = 0.1, alpha = 0.4) +
labs(
title = "Spatial Distribution of Sanitation Code Violations in Chicago",
subtitle = paste0("2017, n = ", nrow(sanitation_sf)),
caption = "Source: Chicago 311 Service Requests (Open Data Portal)"
) +
theme_minimal() +
theme(
plot.title = element_text(face = "bold", size = 14),
plot.subtitle = element_text(color = "gray40"),
axis.text = element_blank(),
axis.title = element_blank(),
panel.grid = element_blank()
)
# Save locally under /data/Sanitation.csv
sanitation_raw <- read_csv("Sanitation.csv")
# 1.2 Quick check of structure and basic fields
glimpse(sanitation_raw)
# 1.3 Clean and convert to spatial points (keep necessary columns)
# Adjust variable names based on actual CSV field names
sanitation_sf <- sanitation_raw %>%
mutate(CreationDate = mdy(`Creation Date`),
Year = year(CreationDate)) %>%
filter(Year == 2017,
!is.na(Latitude), !is.na(Longitude)) %>%
st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326) %>%
st_transform('ESRI:102271')
# Load Chicago boundary for context
chicagoBoundary <- st_read("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/Chapter5/chicagoBoundary.geojson") %>%
st_transform('ESRI:102271')
# Quick spatial plot: where are the violations located?
ggplot() +
geom_sf(data = chicagoBoundary, fill = "gray95", color = "gray60") +
geom_sf(data = sanitation_sf, color = "#d62828", size = 0.1, alpha = 0.4) +
labs(
title = "Spatial Distribution of Sanitation Code Violations in Chicago",
subtitle = paste0("2017, n = ", nrow(sanitation_sf)),
caption = "Source: Chicago 311 Service Requests (Open Data Portal)"
) +
theme_minimal() +
theme(
plot.title = element_text(face = "bold", size = 14),
plot.subtitle = element_text(color = "gray40"),
axis.text = element_blank(),
axis.title = element_blank(),
panel.grid = element_blank()
)
# Verify result
cat("✓ 311 sanitation records for 2017:", nrow(sanitation_sf), "\n")
# 2.1 Create 500m x 500m fishnet grid over Chicago
fishnet <- st_make_grid(
chicagoBoundary,
cellsize = 500,   # 500 meters per cell
square = TRUE
) %>%
st_sf() %>%
mutate(uniqueID = row_number()) %>%
filter(lengths(st_intersects(., chicagoBoundary)) > 0)
cat("✓ Created fishnet grid with", nrow(fishnet), "cells\n")
sanitation_count <- st_join(sanitation_sf, fishnet, join = st_within) %>%
st_drop_geometry() %>%
group_by(uniqueID) %>%
summarise(countSanitation = n())
fishnet <- fishnet %>%
left_join(sanitation_count, by = "uniqueID") %>%
mutate(countSanitation = replace_na(countSanitation, 0))
summary(fishnet$countSanitation)
ggplot() +
geom_sf(data = fishnet, aes(fill = countSanitation), color = NA) +
geom_sf(data = chicagoBoundary, fill = NA, color = "white", linewidth = 0.7) +
scale_fill_viridis_c(
name = "Violations",
option = "plasma",
trans = "sqrt",
breaks = c(0, 1, 5, 10, 20, 40)
) +
labs(
title = "Sanitation Code Violations by 500m Grid Cell",
subtitle = "Chicago, 2017",
caption = "Source: Chicago 311 Service Requests (Open Data Portal)"
) +
theme_minimal() +
theme(
plot.title = element_text(face = "bold", size = 14),
plot.subtitle = element_text(color = "gray40"),
axis.text = element_blank(),
axis.title = element_blank(),
panel.grid = element_blank()
)
# 3.1 k-Nearest Neighbor (3-NN) Feature ----
# Calculate mean distance from each grid centroid to 3 nearest violation points
fishnet_centroids <- st_centroid(fishnet)
san_coords <- st_coordinates(sanitation_sf)
fish_coords <- st_coordinates(fishnet_centroids)
nn_result <- get.knnx(san_coords, fish_coords, k = 3)
fishnet$nn_meanDist <- rowMeans(nn_result$nn.dist)
summary(fishnet$nn_meanDist)
cat("✓ Added 3-NN mean distance feature\n")
# 3.2 Local Moran’s I (cluster detection) ----
# Spatial weights based on 5 nearest neighboring cells
coords <- st_coordinates(fishnet_centroids)
nb <- knn2nb(knearneigh(coords, k = 5))
lw <- nb2listw(nb, style = "W", zero.policy = TRUE)
localM <- localmoran(fishnet$countSanitation, lw)
mean_val <- mean(fishnet$countSanitation, na.rm = TRUE)
fishnet <- fishnet %>%
mutate(
localI = localM[, 1],
p_value = localM[, 5],
significant = p_value < 0.05,
clusterType = case_when(
!significant ~ "Not Significant",
localI > 0 & countSanitation > mean_val ~ "High-High",
localI > 0 & countSanitation <= mean_val ~ "Low-Low",
localI < 0 & countSanitation > mean_val ~ "High-Low",
localI < 0 & countSanitation <= mean_val ~ "Low-High",
TRUE ~ "Not Significant"
)
)
ggplot() +
geom_sf(data = fishnet, aes(fill = clusterType), color = NA) +
scale_fill_manual(
values = c(
"High-High" = "#d7191c",
"High-Low"  = "#fdae61",
"Low-High"  = "#abd9e9",
"Low-Low"   = "#2c7bb6",
"Not Significant" = "gray90"
),
name = "Cluster Type"
) +
labs(
title = "Local Moran’s I: Sanitation Violation Clusters",
subtitle = "High-High = Hot Spots  |  Low-Low = Cold Spots"
) +
theme_minimal() +
theme(
plot.title = element_text(face = "bold", size = 14),
plot.subtitle = element_text(color = "gray40"),
axis.text = element_blank(),
axis.title = element_blank(),
panel.grid = element_blank()
)
hotspots <- fishnet %>%
filter(clusterType == "High-High") %>%
st_centroid()
fishnet$dist_to_hotspot <- as.numeric(
st_distance(fishnet_centroids, hotspots %>% st_union())
)
summary(fishnet$dist_to_hotspot)
cat("✓ Calculated distance to nearest High-High cluster\n")
fishnet_model <- fishnet %>%
st_drop_geometry() %>%
select(
uniqueID,
countSanitation,
nn_meanDist,
dist_to_hotspot
) %>%
na.omit()
View(fishnet)
fishnet_model <- fishnet %>%
st_drop_geometry() %>%
select(uniqueID, countSanitation, nn_meanDist, dist_to_hotspot) %>%
na.omit()
fishnet_model <- fishnet %>%
st_drop_geometry() %>%
select(uniqueID, countSanitation, nn_meanDist, dist_to_hotspot) %>%
na.omit()
class(fishnet)
fishnet_model <- fishnet %>%
st_drop_geometry() %>%
select(uniqueID, countSanitation, nn_meanDist, dist_to_hotspot) %>%
drop_na()
fishnet_model <- fishnet %>%
st_drop_geometry() %>%
as.data.frame() %>%
dplyr::select(uniqueID, countSanitation, nn_meanDist, dist_to_hotspot) %>%
tidyr::drop_na()
fishnet_model <- fishnet %>%
st_drop_geometry() %>%
as.data.frame() %>%
dplyr::select(uniqueID, countSanitation, nn_meanDist, dist_to_hotspot) %>%
tidyr::drop_na()
cat("✓ Modeling dataset ready with", nrow(fishnet_model), "observations\n")
model_pois <- glm(
countSanitation ~ nn_meanDist + dist_to_hotspot,
data = fishnet_model,
family = "poisson"
)
summary(model_pois)
dispersion <- sum(residuals(model_pois, type = "pearson")^2) /
model_pois$df.residual
cat("\nDispersion parameter:", round(dispersion, 2), "\n")
if (dispersion > 1.5) {
cat("⚠ Overdispersion detected — Negative Binomial model recommended.\n")
} else {
cat("✓ Dispersion acceptable for Poisson model.\n")
}
model_nb <- glm.nb(
countSanitation ~ nn_meanDist + dist_to_hotspot,
data = fishnet_model
)
summary(model_nb)
cat("\nModel Fit Comparison:\n")
cat("Poisson AIC:", round(AIC(model_pois), 2), "\n")
cat("NegBin  AIC:", round(AIC(model_nb), 2), "\n")
policeDistricts <- st_read("https://data.cityofchicago.org/api/geospatial/24zt-jpfn?method=export&format=GeoJSON") %>%
st_transform('ESRI:102271') %>%
dplyr::select(District = dist_num)
fishnet <- st_join(fishnet, policeDistricts, join = st_within, left = TRUE) %>%
filter(!is.na(District))
cat("✓ Joined police districts:", length(unique(fishnet$District)), "\n")
fishnet_model <- fishnet %>%
st_drop_geometry() %>%
as.data.frame() %>%
dplyr::select(uniqueID, District, countSanitation, nn_meanDist, dist_to_hotspot) %>%
tidyr::drop_na()
cat("✓ Data ready for LOGO CV with", nrow(fishnet_model), "observations\n")
districts <- unique(fishnet_model$District)
cv_results <- tibble()
cat("Running LOGO cross-validation across", length(districts), "districts...\n")
for (i in seq_along(districts)) {
test_district <- districts[i]
train_data <- fishnet_model %>% filter(District != test_district)
test_data  <- fishnet_model %>% filter(District == test_district)
model_cv <- glm.nb(countSanitation ~ nn_meanDist + dist_to_hotspot, data = train_data)
test_data <- test_data %>%
mutate(prediction = predict(model_cv, newdata = test_data, type = "response"))
mae  <- mean(abs(test_data$countSanitation - test_data$prediction))
rmse <- sqrt(mean((test_data$countSanitation - test_data$prediction)^2))
cv_results <- bind_rows(cv_results, tibble(
fold = i,
test_district = test_district,
n_test = nrow(test_data),
MAE = mae,
RMSE = rmse
))
cat("  Fold", i, "/", length(districts),
"- District", test_district,
"- MAE:", round(mae, 2),
"- RMSE:", round(rmse, 2), "\n")
}
cat("\n✓ LOGO Cross-Validation complete\n")
cat("Mean MAE :", round(mean(cv_results$MAE), 2), "\n")
cat("Mean RMSE:", round(mean(cv_results$RMSE), 2), "\n")
cv_results %>%
arrange(desc(MAE)) %>%
kable(
digits = 2,
caption = "Leave-One-District-Out Cross-Validation Results"
) %>%
kable_styling(bootstrap_options = c("striped", "hover"))
library(knitr)
library(kableExtra)
cv_results %>%
arrange(desc(MAE)) %>%
kable(
digits = 2,
caption = "Leave-One-District-Out Cross-Validation Results"
) %>%
kable_styling(bootstrap_options = c("striped", "hover"))
fishnet_model$pred_2017 <- predict(model_nb, newdata = fishnet_model, type = "response")
cat("✓ Generated in-sample predictions for 2017\n")
sanitation_2018 <- read_csv("Sanitation.csv") %>%
mutate(CreationDate = mdy(`Creation Date`),
Year = year(CreationDate)) %>%
filter(Year == 2018,
!is.na(Latitude), !is.na(Longitude)) %>%
st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326) %>%
st_transform('ESRI:102271')
cat("✓ Loaded 2018 sanitation records:", nrow(sanitation_2018), "\n")
fishnet_2018 <- st_join(fishnet, sanitation_2018, join = st_contains) %>%
st_drop_geometry() %>%
group_by(uniqueID) %>%
summarise(count2018 = n()) %>%
right_join(fishnet_model, by = "uniqueID") %>%
mutate(count2018 = ifelse(is.na(count2018), 0, count2018))
cat("✓ Aggregated 2018 counts to fishnet grid\n")
fishnet_2018$pred_2018 <- predict(model_nb, newdata = fishnet_2018, type = "response")
fishnet_2018 <- fishnet_2018 %>%
mutate(error = count2018 - pred_2018)
mae_2018 <- mean(abs(fishnet_2018$error))
rmse_2018 <- sqrt(mean((fishnet_2018$error)^2))
cat("✓ 2018 Temporal Validation complete\n")
cat("MAE (2018):", round(mae_2018, 2), "\n")
cat("RMSE (2018):", round(rmse_2018, 2), "\n")
points2017 <- sanitation_sf %>%
st_coordinates() %>%
as.data.frame()
kde_2017 <- spatstat.geom::ppp(points2017$X, points2017$Y,
window = spatstat.geom::as.owin(st_union(chicagoBoundary)))
kde_density <- spatstat.explore::density.ppp(kde_2017, sigma = 1000) # bandwidth 1km
fishnet_2018$kde_pred <- raster::extract(raster::raster(kde_density),
st_coordinates(st_centroid(fishnet)))
kde_mae  <- mean(abs(fishnet_2018$count2018 - fishnet_2018$kde_pred), na.rm = TRUE)
kde_rmse <- sqrt(mean((fishnet_2018$count2018 - fishnet_2018$kde_pred)^2, na.rm = TRUE))
cat("✓ KDE baseline complete\n")
cat("KDE MAE:", round(kde_mae, 2), "\n")
cat("KDE RMSE:", round(kde_rmse, 2), "\n")
ggplot() +
geom_sf(data = chicagoBoundary, fill = "gray95", color = "white") +
geom_sf(data = fishnet, aes(fill = error), color = NA) +
scale_fill_gradient2(low = "#2c7bb6", mid = "white", high = "#d7191c", midpoint = 0) +
labs(title = "Prediction Errors for 2018 (Observed - Predicted)",
fill = "Error") +
theme_minimal()
View(fishnet)
View(fishnet_2018)
ggplot() +
geom_sf(data = chicagoBoundary, fill = "gray95", color = "white") +
geom_sf(data = fishnet_2018, aes(fill = error), color = NA) +
scale_fill_gradient2(
low = "#2c7bb6",
mid = "white",
high = "#d7191c",
midpoint = 0,
name = "Prediction Error"
) +
labs(
title = "Prediction Errors for 2018 (Observed - Predicted)",
subtitle = "Negative Binomial Model",
caption = "Blue = Overprediction, Red = Underprediction"
) +
theme_minimal()
fishnet_model$pred_2017 <- predict(model_nb, newdata = fishnet_model, type = "response")
cat("✓ Generated in-sample predictions for 2017\n")
sanitation_2018 <- read_csv("Sanitation.csv") %>%
mutate(CreationDate = mdy(`Creation Date`),
Year = year(CreationDate)) %>%
filter(Year == 2018,
!is.na(Latitude), !is.na(Longitude)) %>%
st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326) %>%
st_transform('ESRI:102271')
cat("✓ Loaded 2018 sanitation records:", nrow(sanitation_2018), "\n")
fishnet_2018 <- st_join(fishnet, sanitation_2018, join = st_contains) %>%
group_by(uniqueID) %>%
summarise(count2018 = n()) %>%
right_join(fishnet_model, by = "uniqueID") %>%
mutate(count2018 = ifelse(is.na(count2018), 0, count2018))
cat("✓ Aggregated 2018 counts to fishnet grid\n")
fishnet_2018$pred_2018 <- predict(model_nb, newdata = fishnet_2018, type = "response")
fishnet_2018 <- fishnet_2018 %>%
mutate(error = count2018 - pred_2018)
mae_2018 <- mean(abs(fishnet_2018$error))
rmse_2018 <- sqrt(mean((fishnet_2018$error)^2))
cat("✓ 2018 Temporal Validation complete\n")
cat("MAE (2018):", round(mae_2018, 2), "\n")
cat("RMSE (2018):", round(rmse_2018, 2), "\n")
points2017 <- sanitation_sf %>%
st_coordinates() %>%
as.data.frame()
kde_2017 <- spatstat.geom::ppp(points2017$X, points2017$Y,
window = spatstat.geom::as.owin(st_union(chicagoBoundary)))
kde_density <- spatstat.explore::density.ppp(kde_2017, sigma = 1000) # bandwidth 1km
fishnet_2018$kde_pred <- raster::extract(raster::raster(kde_density),
st_coordinates(st_centroid(fishnet)))
kde_mae  <- mean(abs(fishnet_2018$count2018 - fishnet_2018$kde_pred), na.rm = TRUE)
kde_rmse <- sqrt(mean((fishnet_2018$count2018 - fishnet_2018$kde_pred)^2, na.rm = TRUE))
cat("✓ KDE baseline complete\n")
cat("KDE MAE:", round(kde_mae, 2), "\n")
cat("KDE RMSE:", round(kde_rmse, 2), "\n")
ggplot() +
geom_sf(data = chicagoBoundary, fill = "gray95", color = "white") +
geom_sf(data = fishnet_2018, aes(fill = error), color = NA) +
scale_fill_gradient2(
low = "#2c7bb6",
mid = "white",
high = "#d7191c",
midpoint = 0,
name = "Prediction Error"
) +
labs(
title = "Prediction Errors for 2018 (Observed - Predicted)",
subtitle = "Negative Binomial Model",
caption = "Blue = Overprediction, Red = Underprediction"
) +
theme_minimal()
ggplot() +
geom_sf(data = chicagoBoundary, fill = "gray95", color = "white") +
geom_sf(data = fishnet_2018, aes(fill = error), color = NA) +
scale_fill_gradient2(
low = "#2c7bb6",
mid = "white",
high = "#d7191c",
midpoint = 0,
name = "Prediction Error"
) +
labs(
title = "Prediction Errors for 2018 (Observed - Predicted)",
subtitle = "Negative Binomial Model",
caption = "Blue = Overprediction, Red = Underprediction"
) +
theme_minimal() +
theme(
plot.title = element_text(face = "bold", size = 14),
plot.subtitle = element_text(color = "gray40"),
axis.text = element_blank(),
axis.title = element_blank(),
panel.grid = element_blank()
)
sanitation_2018_sf <- sanitation_raw %>%
mutate(CreationDate = lubridate::mdy(`Creation Date`),
Year = lubridate::year(CreationDate)) %>%
filter(Year == 2018) %>%
filter(!is.na(Longitude) & !is.na(Latitude)) %>%
st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326) %>%
st_transform(st_crs(fishnet))
cat("✓ Loaded 2018 sanitation records:", nrow(sanitation_2018_sf), "\n")
fishnet_2018 <- st_join(fishnet, sanitation_2018_sf, join = st_contains) %>%
group_by(uniqueID) %>%
summarise(count2018 = n()) %>%
right_join(fishnet, by = "uniqueID") %>%
mutate(count2018 = ifelse(is.na(count2018), 0, count2018))
fishnet_2018 <- st_join(fishnet, sanitation_2018_sf, join = st_contains) %>%
st_drop_geometry() %>%
group_by(uniqueID) %>%
summarise(count2018 = n()) %>%
right_join(st_drop_geometry(fishnet), by = "uniqueID") %>%
mutate(count2018 = ifelse(is.na(count2018), 0, count2018)) %>%
st_as_sf()
sanitation_2018_sf <- sanitation_raw %>%
mutate(CreationDate = lubridate::mdy(`Creation Date`),
Year = lubridate::year(CreationDate)) %>%
filter(Year == 2018,
!is.na(Longitude), !is.na(Latitude)) %>%
st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326) %>%
st_transform(st_crs(fishnet))
counts_2018 <- st_join(fishnet, sanitation_2018_sf, join = st_contains) %>%
st_drop_geometry() %>%
dplyr::count(uniqueID, name = "count2018")
fishnet_2018 <- fishnet %>%                               # 保留 fishnet 的 geometry
dplyr::left_join(counts_2018, by = "uniqueID") %>%      # 只拼数表，不动几何
dplyr::mutate(count2018 = tidyr::replace_na(count2018, 0L))
fishnet_2018$pred_2018 <- predict(
model_nb,
newdata = fishnet_2018 %>% st_drop_geometry(),  # 模型只要字段，不要几何
type = "response"
)
fishnet_2018 <- fishnet_2018 %>%
dplyr::mutate(error = count2018 - pred_2018)
mae_2018  <- mean(abs(fishnet_2018$error))
rmse_2018 <- sqrt(mean((fishnet_2018$error)^2))
cat("MAE_2018:", round(mae_2018, 2), " RMSE_2018:", round(rmse_2018, 2), "\n")
ggplot() +
geom_sf(data = chicagoBoundary, fill = "gray95", color = "white") +
geom_sf(data = fishnet_2018, aes(fill = error), color = NA) +
scale_fill_gradient2(low = "#2c7bb6", mid = "white", high = "#d7191c", midpoint = 0,
name = "Error (Obs - Pred)") +
labs(title = "Prediction Errors for 2018",
subtitle = "Negative Binomial (trained on 2017)") +
theme_minimal()
crime_2018 <- read_csv("https://data.cityofchicago.org/resource/3i3m-jwuy.csv")
crime_2018_burg <- crime_2018 %>%
filter(primary_type == "BURGLARY",
description == "FORCIBLE ENTRY",
!is.na(longitude), !is.na(latitude)) %>%
mutate(year = year(as_date(date)))
# 检查数量
nrow(crime_2018_burg)
crime_2018_sf <- st_as_sf(
crime_2018_burg,
coords = c("longitude", "latitude"),
crs = 4326
) %>%
st_transform(st_crs(fishnet))
counts_crime_2018 <- st_join(fishnet, crime_2018_sf, join = st_contains) %>%
st_drop_geometry() %>%
count(uniqueID, name = "countCrime2018")
fishnet_crime_2018 <- fishnet %>%
left_join(counts_crime_2018, by = "uniqueID") %>%
mutate(countCrime2018 = replace_na(countCrime2018, 0))
fishnet_crime_2018$predCrime <- predict(
model_nb,
newdata = fishnet_crime_2018 %>% st_drop_geometry(),
type = "response"
)
fishnet_crime_2018 <- fishnet_crime_2018 %>%
mutate(error = countCrime2018 - predCrime)
mae_crime <- mean(abs(fishnet_crime_2018$error))
rmse_crime <- sqrt(mean((fishnet_crime_2018$error)^2))
cat("2018 Burglary Temporal Validation → MAE:", round(mae_crime, 2),
" RMSE:", round(rmse_crime, 2), "\n")
ggplot() +
geom_sf(data = chicagoBoundary, fill = "gray95", color = "white") +
geom_sf(data = fishnet_crime_2018, aes(fill = error), color = NA) +
scale_fill_gradient2(low = "#2c7bb6", mid = "white", high = "#d7191c",
midpoint = 0, name = "Error (Obs - Pred)") +
labs(title = "2018 Burglary (FORCIBLE ENTRY) Prediction Errors",
subtitle = "Predicted using 2017 Sanitation Model",
caption = "Blue = Overprediction, Red = Underprediction") +
theme_minimal()
ggplot() +
geom_sf(data = chicagoBoundary, fill = "gray95", color = "white") +
geom_sf(data = fishnet_crime_2018, aes(fill = error), color = NA) +
scale_fill_gradient2(low = "#2c7bb6", mid = "white", high = "#d7191c",
midpoint = 0, name = "Error (Obs - Pred)") +
labs(title = "2018 Burglary (FORCIBLE ENTRY) Prediction Errors",
subtitle = "Predicted using 2017 Sanitation Model",
caption = "Blue = Overprediction, Red = Underprediction") +
theme_minimal() +
theme(
plot.title = element_text(face = "bold", size = 14),
plot.subtitle = element_text(color = "gray40"),
axis.text = element_blank(),
axis.title = element_blank(),
panel.grid = element_blank()
)
