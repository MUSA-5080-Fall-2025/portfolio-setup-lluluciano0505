median_income + ba_rate + log(unemployment_rate+1) + black_share +
crime_count + I(crime_count^2) +
transit_count + recreation_count + nearest_hospital_m + I(nearest_hospital_m^2)
fml4 <- sale_price ~
total_livable_area + number_of_bedrooms +
number_of_bathrooms + house_age + I(house_age^2) +
median_income + ba_rate + crime_count*unemployment_rate + black_share +
has_garage + center_city_dummy + recreation_dummy +
transit_count + nearest_hospital_m + I(nearest_hospital_m^2)
set.seed(42)
cv_control <- trainControl(method = "cv", number = 10, savePredictions = "final")
m1 <- train(fml1, data = model_data, method = "lm", trControl = cv_control)
m2 <- train(fml2, data = model_data, method = "lm", trControl = cv_control)
m3 <- train(fml3, data = model_data, method = "lm", trControl = cv_control)
m4 <- train(fml4, data = model_data, method = "lm", trControl = cv_control)
results <- resamples(list(
Model1 = m1, Model2 = m2, Model3 = m3, Model4 = m4
))
summary(results)
# Cross-validation average metrics
model_results <- tibble(
Model = c("Model 1: Structural Only",
"Model 2: + Census Variables",
"Model 3: + Spatial Features",
"Model 4: + Interactions and Fixed Effects"),
MAE = c(106328, 82093, 81709, 81139),
RMSE = c(153662, 130385, 129308, 129019),
R2 = c(0.450, 0.603, 0.610, 0.612)
)
model_results %>%
gt() %>%
fmt_number(columns = c(MAE, RMSE), decimals = 0) %>%
fmt_number(columns = R2, decimals = 3) %>%
tab_header(
title = "Model Performance (10-Fold Cross Validation)",
subtitle = "Average metrics across resamples"
) %>%
cols_label(
Model = "Model Specification",
MAE = "Mean Absolute Error ($)",
RMSE = "Root Mean Squared Error ($)",
R2 = "R²"
)
plot_df1 <- opa_census %>%
mutate(
pred = predict(model1, newdata = opa_census),
obs = sale_price
) %>%
dplyr::select(pred, obs)
plot_df4 <- opa_census %>%
mutate(
pred = predict(model4, newdata = opa_census),
obs = sale_price
) %>%
dplyr::select(pred, obs)
rmse1 <- 153662   # Model 1 RMSE
r21   <- 0.45     # Model 1 R²
rmse4 <- 129019   # Model 4 RMSE
r24   <- 0.61     # Model 4 R²
p1 <- ggplot(plot_df1, aes(x = pred, y = obs)) +
geom_point(alpha = 0.3, color = "#E69F00") +
geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
labs(
title = "Model 1",
subtitle = paste0("RMSE = ", scales::comma(rmse1),
", R² = ", round(r21, 2))
) +
theme_minimal() +
coord_fixed()
p4 <- ggplot(plot_df4, aes(x = pred, y = obs)) +
geom_point(alpha = 0.3, color = "#4682B4") +
geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
labs(
title = "Model 4",
subtitle = paste0("RMSE = ", scales::comma(rmse4),
", R² = ", round(r24, 2))
) +
theme_minimal() +
coord_fixed()
p1 + p4 +
plot_annotation(
title = "Predicted vs. Actual Sale Prices",
subtitle = "Comparison between Model 1 and Model 4",
theme = theme(plot.title = element_text(size = 16, face = "bold"),
plot.subtitle = element_text(size = 12))
)
model4_std <- lm.beta(model4)
coef_std <- broom::tidy(model4_std) %>%
filter(term != "(Intercept)") %>%
mutate(Standardized = model4_std$standardized.coefficients[term])
top5_std <- coef_std %>%
arrange(desc(abs(Standardized))) %>%
slice(1:10)
kable(
top5_std %>%
dplyr::select(term, estimate, Standardized, std.error, statistic, p.value) %>%
mutate(across(where(is.numeric), ~ round(., 3))),
caption = "Top 10 Standardized Coefficients from Model 4"
)
top5_std %>%
mutate(term = reorder(term, abs(Standardized))) %>%
ggplot(aes(x = term, y = Standardized, fill = Standardized > 0)) +
geom_col(width = 0.6, show.legend = FALSE) +
coord_flip() +
geom_text(aes(label = round(Standardized, 3)),
hjust = ifelse(top5_std$Standardized > 0, -0.1, 1.1),
size = 3.8) +
scale_fill_manual(values = c("skyblue", "hotpink")) +
labs(
title = "Top 10 Standardized Coefficients from Model 4",
x = "",
y = "Standardized Coefficient (β)"
) +
theme_minimal(base_size = 13) +
geom_hline(yintercept = 0, color = "black", linewidth = 0.8) +
expand_limits(y = c(-max(abs(top5_std$Standardized)) * 1.2,
max(abs(top5_std$Standardized)) * 1.2)) +
theme(
plot.title = element_text(face = "bold", hjust = 0.5),
panel.grid.minor = element_blank()
)
par(mfrow = c(1, 1))
# 1. Residuals vs Fitted
plot(model4, which = 1, main = "Residuals vs Fitted")
# 2. Normal Q-Q
plot(model4, which = 2, main = "Q-Q Plot")
# 3. Cook’s distance
plot(model4, which = 4, main = "Cook’s Distance")
opa_census$pred_price <- predict(model4, newdata = opa_census)
opa_ward <- st_join(opa_census, wards["ward_num"])
ward_summary <- opa_ward %>%
st_drop_geometry() %>%
group_by(ward_num) %>%
summarise(
mean_actual = mean(sale_price, na.rm = TRUE),
mean_pred = mean(pred_price, na.rm = TRUE),
median_pred = median(pred_price, na.rm = TRUE),
n_properties = n()
) %>%
mutate(residual_mean = mean_actual - mean_pred) %>%
arrange(desc(residual_mean))
head(ward_summary)
ward_plot_data <- wards %>%
left_join(ward_summary, by = "ward_num")
ggplot(ward_plot_data) +
geom_sf(aes(fill = residual_mean), color = "white", size = 0.2) +
scale_fill_gradient2(
low = "#4575B4",
mid = "white",
high = "#D73027",
midpoint = 0,
labels = scales::label_dollar()
) +
labs(
title = "Mean Prediction Residuals by Ward",
subtitle = "Positive = Underestimation | Negative = Overestimation",
fill = "Actual - Predicted"
) +
theme_minimal(base_size = 11) +
theme(
axis.text = element_blank(),
axis.ticks = element_blank(),
panel.grid = element_blank()
)
ggplot() +
geom_sf(data = philly_census, fill = "lightgrey", color = "white") +
geom_sf(data = opa_census, aes(color = factor(price_quartile)), size = 0.1, alpha = 0.7) +
scale_color_viridis_d(
option = "plasma",
direction = -1,
labels = c("0%-25%", "25%-50%", "50%-75%", "75%-100%")
) +
theme_void(base_size = ) +
theme_minimal() +
labs(
title = "Housing Sales in Philadelphia (2023–2024)",
color = "Sale Price Quartile"
)  +
guides(color = guide_legend(override.aes = list(size = 3)))
ggplot() +
geom_sf(data = philly_census, fill = "lightgrey", color = "white") +
geom_sf(data = opa_census, aes(color = factor(price_quartile)), size = 0.1, alpha = 0.7) +
scale_color_viridis_d(
option = "plasma",
direction = -1,
labels = c("0%-25%", "25%-50%", "50%-75%", "75%-100%")
) +
theme_void() +
theme_minimal() +
labs(
title = "Housing Sales in Philadelphia (2023–2024)",
color = "Sale Price Quartile"
)  +
guides(color = guide_legend(override.aes = list(size = 3)))
library(osmdata)
library(sf)
library(ggplot2)
q <- getbb("Tekes, Xinjiang, China") |> opq()
）
q <- getbb("Tekes, Xinjiang, China") |> opq()
roads <- q %>%
add_osm_feature(key = "highway") %>%
osmdata_sf()
road_lines <- roads$osm_lines
ggplot() +
geom_sf(data = road_lines, color = "#2C7BB6", size = 0.3, alpha = 0.8) +
coord_sf(xlim = c(81.82, 81.92), ylim = c(43.20, 43.30), expand = FALSE) +
theme_void() +
theme(
plot.title = element_text(size = 16, face = "bold"),
plot.subtitle = element_text(size = 12, color = "grey40"),
plot.caption = element_text(size = 9, color = "grey50"),
plot.background = element_rect(fill = "white", color = NA)
) +
labs(
title = "The 'Bagua City' Street Pattern of Tekes, Xinjiang",
subtitle = "八卦城的道路几何 — #30DayMapChallenge Day 2: Lines",
caption = "Data: OpenStreetMap via {osmdata}"
)
ggplot() +
geom_sf(data = road_lines, color = "#2C7BB6", size = 0.3, alpha = 0.8) +
coord_sf(xlim = c(81.83, 81.88), ylim = c(43.215, 43.255), expand = FALSE) +
theme_void() +
theme(
plot.title = element_text(size = 16, face = "bold"),
plot.subtitle = element_text(size = 12, color = "grey40"),
plot.caption = element_text(size = 9, color = "grey50"),
plot.background = element_rect(fill = "white", color = NA)
) +
labs(
title = "The 'Bagua City' Street Pattern of Tekes, Xinjiang",
caption = "Data: OpenStreetMap via {osmdata}"
)
ggplot() +
geom_sf(data = road_lines, color = "#2C7BB6", size = 0.3, alpha = 0.8) +
coord_sf(xlim = c(81.82, 81.92), ylim = c(43.20, 43.30), expand = FALSE) +
theme_void() +
theme(
plot.title = element_text(size = 16, face = "bold"),
plot.subtitle = element_text(size = 12, color = "grey40"),
plot.caption = element_text(size = 9, color = "grey50"),
plot.background = element_rect(fill = "white", color = NA)
) +
labs(
title = "The 'Bagua City' Street Pattern of Tekes, Xinjiang",
caption = "Data: OpenStreetMap via {osmdata}"
)
ggplot() +
geom_sf(data = road_lines, color = "#2C7BB6", size = 0.3, alpha = 0.8) +
coord_sf(xlim = c(81.82, 81.86), ylim = c(43.20, 43.30), expand = FALSE) +
theme_void() +
theme(
plot.title = element_text(size = 16, face = "bold"),
plot.subtitle = element_text(size = 12, color = "grey40"),
plot.caption = element_text(size = 9, color = "grey50"),
plot.background = element_rect(fill = "white", color = NA)
) +
labs(
title = "The 'Bagua City' Street Pattern of Tekes, Xinjiang",
caption = "Data: OpenStreetMap via {osmdata}"
)
ggplot() +
geom_sf(data = road_lines, color = "#2C7BB6", size = 0.3, alpha = 0.8) +
coord_sf(xlim = c(81.82, 81.86), ylim = c(43.20, 43.24), expand = FALSE) +
theme_void() +
theme(
plot.title = element_text(size = 16, face = "bold"),
plot.subtitle = element_text(size = 12, color = "grey40"),
plot.caption = element_text(size = 9, color = "grey50"),
plot.background = element_rect(fill = "white", color = NA)
) +
labs(
title = "The 'Bagua City' Street Pattern of Tekes, Xinjiang",
caption = "Data: OpenStreetMap via {osmdata}"
)
ggplot() +
geom_sf(data = road_lines, color = "#2C7BB6", size = 0.3, alpha = 0.8) +
coord_sf(xlim = c(81.82, 81.86), ylim = c(43.20, 43.24), expand = FALSE) +
theme_void() +
theme(
plot.title = element_text(size = 16, face = "bold"),
plot.subtitle = element_text(size = 12, color = "grey40"),
plot.caption = element_text(size = 9, color = "grey50"),
plot.background = element_rect(fill = "white", color = NA)
) +
labs(
title = "The 'Bagua City' Street Pattern of Tekes, Xinjiang",
caption = "Data: OpenStreetMap via {osmdata}"
)
ggplot() +
geom_sf(data = road_lines, color = "#2C7BB6", size = 0.3, alpha = 0.8) +
coord_sf(xlim = c(81.82, 81.86), ylim = c(43.20, 43.24), expand = FALSE) +
theme_void() +
labs(
title = "The 'Bagua City' Street Pattern of Tekes, Xinjiang",
caption = "Data: OpenStreetMap via {osmdata}"
)
#| message: false
#| warning: false
# Load core libraries
library(tidyverse)      # data wrangling
library(sf)             # spatial data
library(here)           # relative paths
library(viridis)        # color scales
library(terra)          # raster ops
library(spdep)          # spatial dependence
library(FNN)            # nearest neighbors
library(MASS)           # negative binomial regression
library(patchwork)      # plot composition
library(knitr)          # tables
library(kableExtra)     # table formatting
library(classInt)       # classification intervals
# spatstat split packages
library(spatstat.geom)
library(spatstat.explore)
# set options
options(scipen = 999)
set.seed(5080)
# custom theme
theme_musa <- function(base_size = 11) {
theme_minimal(base_size = base_size) +
theme(
plot.title = element_text(face = "bold", size = base_size + 1),
plot.subtitle = element_text(color = "gray30", size = base_size - 1),
legend.position = "right",
panel.grid.minor = element_blank(),
axis.text = element_blank(),
axis.title = element_blank()
)
}
theme_set(theme_musa())
cat("✓ Packages loaded\n")
cat("✓ Working directory:", getwd(), "\n")
# Part 1: Load and Explore Data
## 1.1 Load Sanitation 311 Data
# Read CSV
sanitation_raw <- read_csv("Sanitation.csv")
# Part 1: Load and Explore Data
## 1.1 Load Sanitation 311 Data
# Read CSV
sanitation_raw <- read_csv("Sanitation.csv")
View(sanitation_raw)
install.packages("tigris")
# Load required packages
library(sf)
library(dplyr)
library(tigris)
options(tigris_use_cache = TRUE, tigris_class = "sf")
library(tidycensus)
install.packages("tidycensus")
library(sf)
library(dplyr)
library(tigris)
options(tigris_use_cache = TRUE, tigris_class = "sf")
library(tidycensus)
library(knitr)
library(ggplot2)
library(scales)
#| message: false
#| warning: false
# Step 0. Setup ----
library(tidyverse)
library(sf)
library(here)
library(spatstat.geom)
library(spatstat.explore)
library(terra)
library(FNN)
library(spdep)
library(MASS)
library(lubridate)
library(knitr)
library(kableExtra)
set.seed(5080)
options(scipen = 999)
setwd("~/GitHub/portfolio-setup-lluluciano0505/assignments")
# Save locally under /data/Sanitation.csv
sanitation_raw <- read_csv("data/Sanitation.csv")
# 1.2 Clean and convert to spatial points (keep necessary columns)
# Adjust variable names based on actual CSV field names
sanitation_sf <- sanitation_raw %>%
mutate(CreationDate = mdy(`Creation Date`),
Year = year(CreationDate)) %>%
filter(Year == 2017,
!is.na(Latitude), !is.na(Longitude)) %>%
st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326) %>%
st_transform('ESRI:102271')
# 1.2 Clean and convert to spatial points (keep necessary columns)
# Adjust variable names based on actual CSV field names
sanitation_sf <- sanitation_raw %>%
mutate(CreationDate = mdy(`Creation Date`),
Year = year(CreationDate)) %>%
filter(Year == 2017,
!is.na(Latitude), !is.na(Longitude)) %>%
st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326) %>%
st_transform('ESRI:102271')
# Load Chicago boundary for context
chicagoBoundary <- st_read("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/Chapter5/chicagoBoundary.geojson") %>%
st_transform('ESRI:102271')
# Quick spatial plot: where are the violations located?
ggplot() +
geom_sf(data = chicagoBoundary, fill = "gray95", color = "gray60") +
geom_sf(data = sanitation_sf, color = "#d62828", size = 0.1, alpha = 0.4) +
labs(
title = "Spatial Distribution of Sanitation Code Violations in Chicago",
subtitle = paste0("2017, n = ", nrow(sanitation_sf)),
caption = "Source: Chicago 311 Service Requests (Open Data Portal)"
) +
theme_minimal() +
theme(
plot.title = element_text(face = "bold", size = 14),
plot.subtitle = element_text(color = "gray40"),
axis.text = element_blank(),
axis.title = element_blank(),
panel.grid = element_blank()
)
# Verify result
cat("✓ 311 sanitation records for 2017:", nrow(sanitation_sf), "\n")
# Load Chicago boundary for context
chicagoBoundary <- st_read("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/Chapter5/chicagoBoundary.geojson") %>%
st_transform('ESRI:102271')
# Quick spatial plot: where are the violations located?
ggplot() +
geom_sf(data = chicagoBoundary, fill = "gray95", color = "gray60") +
geom_sf(data = sanitation_sf, color = "#d62828", size = 0.1, alpha = 0.4) +
labs(
title = "Spatial Distribution of Sanitation Code Violations in Chicago",
subtitle = paste0("2017, n = ", nrow(sanitation_sf)),
plot.subtitle = element_text(color = "gray40"),
axis.text = element_blank(),
axis.title = element_blank(),
panel.grid = element_blank()
)
# Verify result
cat("✓ 311 sanitation records for 2017:", nrow(sanitation_sf), "\n")
# Load Chicago boundary for context
chicagoBoundary <- st_read("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/Chapter5/chicagoBoundary.geojson") %>%
st_transform('ESRI:102271')
# Quick spatial plot: where are the violations located?
ggplot() +
geom_sf(data = chicagoBoundary, fill = "gray95", color = "gray60") +
geom_sf(data = sanitation_sf, color = "#d62828", size = 0.1, alpha = 0.4) +
labs(
title = "Spatial Distribution of Sanitation Code Violations in Chicago",
subtitle = paste0("2017, n = ", nrow(sanitation_sf)),
plot.subtitle = element_text(color = "gray40"),
axis.text = element_blank(),
axis.title = element_blank(),
panel.grid = element_blank()
)
# Verify result
cat("✓ 311 sanitation records for 2017:", nrow(sanitation_sf), "\n")
message: false
| message: false
options(scipen = 999)
# Global chunk options: don't print messages/warnings in the report
knitr::opts_chunk$set(
message = FALSE,
warning = FALSE
)
# Packages
library(tidyverse)
library(sf)
library(here)
library(spatstat.geom)
library(spatstat.explore)
library(terra)
library(FNN)
library(spdep)
library(MASS)
library(lubridate)
library(knitr)
library(kableExtra)
set.seed(5080)
options(scipen = 999)
# Save locally under /data/Sanitation.csv
sanitation_raw <- read_csv("data/Sanitation.csv")
# 1.2 Clean and convert to spatial points (keep necessary columns)
# Adjust variable names based on actual CSV field names
sanitation_sf <- sanitation_raw %>%
mutate(CreationDate = mdy(`Creation Date`),
Year = year(CreationDate)) %>%
filter(Year == 2017,
!is.na(Latitude), !is.na(Longitude)) %>%
st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326) %>%
st_transform('ESRI:102271')
# Load Chicago boundary for context
chicagoBoundary <- st_read("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/Chapter5/chicagoBoundary.geojson") %>%
st_transform('ESRI:102271')
# Quick spatial plot: where are the violations located?
ggplot() +
geom_sf(data = chicagoBoundary, fill = "gray95", color = "gray60") +
geom_sf(data = sanitation_sf, color = "#d62828", size = 0.1, alpha = 0.4) +
labs(
title = "Spatial Distribution of Sanitation Code Violations in Chicago",
subtitle = paste0("2017, n = ", nrow(sanitation_sf)),
plot.subtitle = element_text(color = "gray40"),
axis.text = element_blank(),
axis.title = element_blank(),
panel.grid = element_blank()
)
# Verify result
cat("✓ 311 sanitation records for 2017:", nrow(sanitation_sf), "\n")
fishnet <- st_make_grid(
chicagoBoundary,
cellsize = 500,   # 500 meters per cell
square = TRUE
) %>%
st_sf() %>%
mutate(uniqueID = row_number()) %>%
filter(lengths(st_intersects(., chicagoBoundary)) > 0)
cat("✓ Created fishnet grid with", nrow(fishnet), "cells\n")
