{
  "hash": "f4ea4487f5c4347bdda593eebf3043e7",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Spatial Predictive Modeling – Sanitation 311 Requests\"\nsubtitle: \"MUSA 5080 – Fall 2025\"\nauthor: \"Jingqi Lu\"\ndate: today\nformat:\n  html:\n    code-fold: show\n    code-tools: true\n    toc: true\n    toc-depth: 3\n    toc-location: left\n    theme: cosmo\n    embed-resources: true\neditor: visual\nexecute:\n  warning: false\n  message: false\n---\n\n\n\n## Step 1: Choose sanitation complaints as predict data\n\nIn this step, I subset the raw 311 sanitation requests to 2017 observations with valid geographic coordinates and project them to ESRI:102271, creating a clean point dataset of 19,733 violations for spatial analysis.\n\n### Getting the Data\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Save locally under /data/Sanitation.csv\nsanitation_raw <- read_csv(\"data/Sanitation.csv\")\n\n# 1.2 Clean and convert to spatial points (keep necessary columns)\n# Adjust variable names based on actual CSV field names\nsanitation_sf <- sanitation_raw %>%\n  mutate(CreationDate = mdy(`Creation Date`),\n         Year = year(CreationDate)) %>%\n  filter(Year == 2017,\n         !is.na(Latitude), !is.na(Longitude)) %>%\n  st_as_sf(coords = c(\"Longitude\", \"Latitude\"), crs = 4326) %>%\n  st_transform('ESRI:102271')\n```\n:::\n\n\n## Step 2: Exploratory Spatial Analysis\n\nTo analyze spatial variation in complaint intensity, I construct a 500 m × 500 m fishnet grid over Chicago, aggregate sanitation violations to each cell, and map the resulting count distribution.\n\n#### Part 1: Data Loading & Exploration\n\nIn this part, I load the raw sanitation 311 service request data and the Chicago city boundary, then filter the requests to 2017 incidents with valid latitude–longitude coordinates. Both layers are projected into a common planar CRS (ESRI:102271) so that distances are measured in meters and are suitable for subsequent spatial analysis. The exploratory point map shows that sanitation code violations are far from uniformly distributed: they cluster along central, south, and west corridors of the city, while the North Side exhibits lighter, more scattered activity. This initial pattern already suggests strong spatial concentration of complaints and motivates a grid-based analysis of variation in complaint intensity across the city.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load Chicago boundary for context\nchicagoBoundary <- suppressMessages(\n  st_read(\n    \"https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/Chapter5/chicagoBoundary.geojson\",\n    quiet = TRUE\n  )\n) |>\n  st_transform(\"ESRI:102271\")\n\n\n# Quick spatial plot: where are the violations located?\nggplot() +\n  geom_sf(data = chicagoBoundary, fill = \"gray95\", color = \"gray60\") +\n  geom_sf(data = sanitation_sf, color = \"#d62828\", size = 0.1, alpha = 0.4) +\n  labs(\n    title = \"Spatial Distribution of Sanitation Code Violations in Chicago\",\n    subtitle = paste0(\"2017, n = \", nrow(sanitation_sf)),\n    caption = \"Source: Chicago 311 Service Requests (Open Data Portal)\"\n  ) +\n  theme_void() +\n  theme(\n    plot.title = element_text(face = \"bold\", size = 14),\n    plot.subtitle = element_text(color = \"gray40\")\n  )\n```\n\n::: {.cell-output-display}\n![](Luciano_Lu_assignment4_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# Verify result\ncat(\"311 sanitation records for 2017:\", nrow(sanitation_sf), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n311 sanitation records for 2017: 19733 \n```\n\n\n:::\n:::\n\n\nViolations cluster densely along the city’s central and southern corridors, especially on the South and West Sides. The North Side shows lighter, more scattered activity. Overall, incidents follow residential density and older housing patterns, revealing clear spatial concentration rather than uniform distribution.\n\n#### Part 2: Fishnet Grid Creation\n\nHere I construct a 500 m × 500 m fishnet grid over Chicago, intersect it with the city boundary, and aggregate sanitation violations to each grid cell. This produces a count surface of sanitation complaints that standardizes the spatial unit of analysis across the entire city. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nfishnet <- st_make_grid(\n  chicagoBoundary,\n  cellsize = 500,   # 500 meters per cell\n  square = TRUE\n) %>%\n  st_sf() %>%\n  mutate(uniqueID = row_number()) %>%\n  filter(lengths(st_intersects(., chicagoBoundary)) > 0)\n\ncat(\"✓ Created fishnet grid with\", nrow(fishnet), \"cells\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n✓ Created fishnet grid with 2458 cells\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsanitation_count <- st_join(sanitation_sf, fishnet, join = st_within) %>%\n  st_drop_geometry() %>%\n  group_by(uniqueID) %>%\n  summarise(countSanitation = n())\n\nfishnet <- fishnet %>%\n  left_join(sanitation_count, by = \"uniqueID\") %>%\n  mutate(countSanitation = replace_na(countSanitation, 0))\n\nsummary(fishnet$countSanitation)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n   0.00    1.00    5.00    8.02   12.00  189.00 \n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = fishnet, aes(fill = countSanitation), color = NA) +\n  geom_sf(data = chicagoBoundary, fill = NA, color = \"white\", linewidth = 0.7) +\n  scale_fill_viridis_c(\n    name = \"Violations\",\n    option = \"plasma\",\n    trans = \"sqrt\",\n    breaks = c(0, 1, 5, 10, 20, 40)\n  ) +\n  labs(\n    title = \"Sanitation Code Violations by 500m Grid Cell\",\n    subtitle = \"Chicago, 2017\",\n    caption = \"Source: Chicago 311 Service Requests (Open Data Portal)\"\n  ) +\n  theme_minimal() +\n  theme(\n    plot.title = element_text(face = \"bold\", size = 14),\n    plot.subtitle = element_text(color = \"gray40\"),\n    axis.text = element_blank(),\n    axis.title = element_blank(),\n    panel.grid = element_blank()\n  )\n```\n\n::: {.cell-output-display}\n![](Luciano_Lu_assignment4_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n#### Part 3: Spatial Features\n\nTo capture local spatial context, I derive two key features for each grid cell: the mean distance to the three nearest sanitation events (nn_meanDist) and the distance to the nearest High–High hotspot centroid (dist_to_hotspot). Smaller values of these features indicate tighter clustering of complaints around the cell or closer proximity to a major hotspot. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nfishnet_centroids <- st_centroid(fishnet)\nsan_coords <- st_coordinates(sanitation_sf)\nfish_coords <- st_coordinates(fishnet_centroids)\n\nnn_result <- get.knnx(san_coords, fish_coords, k = 3)\nfishnet$nn_meanDist <- rowMeans(nn_result$nn.dist)\n\nsummary(fishnet$nn_meanDist)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. \n   1.031  108.565  181.606  294.820  332.417 2213.320 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"✓ Added 3-NN mean distance feature\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n✓ Added 3-NN mean distance feature\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncoords <- st_coordinates(fishnet_centroids)\nnb <- knn2nb(knearneigh(coords, k = 5))\nlw <- nb2listw(nb, style = \"W\", zero.policy = TRUE)\n\nlocalM <- localmoran(fishnet$countSanitation, lw)\nmean_val <- mean(fishnet$countSanitation, na.rm = TRUE)\n\nfishnet <- fishnet %>%\n  mutate(\n    localI = localM[, 1],\n    p_value = localM[, 5],\n    significant = p_value < 0.05,\n    clusterType = case_when(\n      !significant ~ \"Not Significant\",\n      localI > 0 & countSanitation > mean_val ~ \"High-High\",\n      localI > 0 & countSanitation <= mean_val ~ \"Low-Low\",\n      localI < 0 & countSanitation > mean_val ~ \"High-Low\",\n      localI < 0 & countSanitation <= mean_val ~ \"Low-High\",\n      TRUE ~ \"Not Significant\"\n    )\n  )\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = fishnet, aes(fill = clusterType), color = NA) +\n  scale_fill_manual(\n    values = c(\n      \"High-High\" = \"#d7191c\",\n      \"High-Low\"  = \"#fdae61\",\n      \"Low-High\"  = \"#abd9e9\",\n      \"Low-Low\"   = \"#2c7bb6\",\n      \"Not Significant\" = \"gray90\"\n    ),\n    name = \"Cluster Type\"\n  ) +\n  labs(\n    title = \"Local Moran’s I: Sanitation Violation Clusters\",\n    subtitle = \"High-High = Hot Spots  |  Low-Low = Cold Spots\"\n  ) +\n  theme_void() +\n  theme(\n    plot.title = element_text(face = \"bold\", size = 14),\n    plot.subtitle = element_text(color = \"gray40\")\n  )\n```\n\n::: {.cell-output-display}\n![](Luciano_Lu_assignment4_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\nHot spots (High-High clusters) of sanitation violations concentrate mainly in the central-west and south-side neighborhoods, with small pockets on the far north and southwest. Cold or low-activity areas dominate the rest of the city. The pattern suggests that sanitation issues are spatially clustered rather than random, aligning with older, denser residential zones and areas of higher population turnover.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhotspots <- fishnet %>%\n  filter(clusterType == \"High-High\") %>%\n  st_centroid()\n\nfishnet$dist_to_hotspot <- as.numeric(\n  st_distance(fishnet_centroids, hotspots %>% st_union())\n)\n\nsummary(fishnet$dist_to_hotspot)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n      0    1000    2000    2479    3606   10000 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Calculated distance to nearest High-High cluster\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCalculated distance to nearest High-High cluster\n```\n\n\n:::\n:::\n\n\n#### Part 4: Count Regression Models\n\nIn this part, I fit Poisson and Negative Binomial count regression models to explain variation in sanitation complaint counts per grid cell using the two spatial features. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nfishnet_model <- fishnet %>%\n  st_drop_geometry() %>%\n  as.data.frame() %>%\n  dplyr::select(uniqueID, countSanitation, nn_meanDist, dist_to_hotspot) %>%\n  tidyr::drop_na()\ncat(\"✓ Modeling dataset ready with\", nrow(fishnet_model), \"observations\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n✓ Modeling dataset ready with 2458 observations\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel_pois <- glm(\n  countSanitation ~ nn_meanDist + dist_to_hotspot,\n  data = fishnet_model,\n  family = \"poisson\"\n)\n\nsummary(model_pois)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nglm(formula = countSanitation ~ nn_meanDist + dist_to_hotspot, \n    family = \"poisson\", data = fishnet_model)\n\nCoefficients:\n                    Estimate   Std. Error z value            Pr(>|z|)    \n(Intercept)      3.726835637  0.014118246  263.97 <0.0000000000000002 ***\nnn_meanDist     -0.008449551  0.000112615  -75.03 <0.0000000000000002 ***\ndist_to_hotspot -0.000183691  0.000005795  -31.70 <0.0000000000000002 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for poisson family taken to be 1)\n\n    Null deviance: 25930.1  on 2457  degrees of freedom\nResidual deviance:  7285.2  on 2455  degrees of freedom\nAIC: 14422\n\nNumber of Fisher Scoring iterations: 5\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndispersion <- sum(residuals(model_pois, type = \"pearson\")^2) /\n              model_pois$df.residual\ncat(\"\\nDispersion parameter:\", round(dispersion, 2), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nDispersion parameter: 4.54 \n```\n\n\n:::\n\n```{.r .cell-code}\nif (dispersion > 1.5) {\n  cat(\"⚠ Overdispersion detected — Negative Binomial model recommended.\\n\")\n} else {\n  cat(\"✓ Dispersion acceptable for Poisson model.\\n\")\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n⚠ Overdispersion detected — Negative Binomial model recommended.\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel_nb <- glm.nb(\n  countSanitation ~ nn_meanDist + dist_to_hotspot,\n  data = fishnet_model\n)\n\nsummary(model_nb)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nglm.nb(formula = countSanitation ~ nn_meanDist + dist_to_hotspot, \n    data = fishnet_model, init.theta = 4.336138091, link = log)\n\nCoefficients:\n                    Estimate   Std. Error z value            Pr(>|z|)    \n(Intercept)      3.835903696  0.028620797  134.03 <0.0000000000000002 ***\nnn_meanDist     -0.009733402  0.000182836  -53.24 <0.0000000000000002 ***\ndist_to_hotspot -0.000141165  0.000009441  -14.95 <0.0000000000000002 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for Negative Binomial(4.3361) family taken to be 1)\n\n    Null deviance: 10094.5  on 2457  degrees of freedom\nResidual deviance:  2054.6  on 2455  degrees of freedom\nAIC: 11212\n\nNumber of Fisher Scoring iterations: 1\n\n              Theta:  4.336 \n          Std. Err.:  0.202 \n\n 2 x log-likelihood:  -11204.329 \n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncat(\"\\nModel Fit Comparison:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nModel Fit Comparison:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Poisson AIC:\", round(AIC(model_pois), 2), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPoisson AIC: 14422.11 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"NegBin  AIC:\", round(AIC(model_nb), 2), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nNegBin  AIC: 11212.33 \n```\n\n\n:::\n:::\n\n\nThe Poisson model showed clear overdispersion (dispersion = 4.54 \\> 1.5). The Negative Binomial model substantially improved fit (AIC = 11 212 vs 14 422). Both predictors were highly significant and negative: greater distance to nearby violations or to cluster centers corresponds to fewer sanitation code violations. This pattern indicates spatial clustering of violations within central and southern neighborhoods.\n\n#### Part 5: Spatial Cross-Validation (2017)\n\nTo evaluate spatial generalization, I implement a Leave-One-District-Out (LOGO) cross-validation using Chicago’s 22 police districts as spatial folds. \n\n\n::: {.cell}\n\n```{.r .cell-code}\npoliceDistricts <- suppressMessages(\n  st_read(\n    \"https://data.cityofchicago.org/api/geospatial/24zt-jpfn?method=export&format=GeoJSON\",\n    quiet = TRUE\n  )\n) |>\n  st_transform(\"ESRI:102271\") |>\n  dplyr::select(District = dist_num)\n\nfishnet <- st_join(fishnet, policeDistricts, join = st_within, left = TRUE) %>%\n  filter(!is.na(District))\n\ncat(\"✓ Joined police districts:\", length(unique(fishnet$District)), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n✓ Joined police districts: 22 \n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfishnet_model <- fishnet %>%\n  st_drop_geometry() %>%\n  as.data.frame() %>%\n  dplyr::select(uniqueID, District, countSanitation, nn_meanDist, dist_to_hotspot) %>%\n  tidyr::drop_na()\n\ncat(\"Data ready for LOGO CV with\", nrow(fishnet_model), \"observations\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nData ready for LOGO CV with 1708 observations\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndistricts <- unique(fishnet_model$District)\ncv_results <- tibble()\n\ncat(\"Running LOGO cross-validation across\", length(districts), \"districts...\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRunning LOGO cross-validation across 22 districts...\n```\n\n\n:::\n\n```{.r .cell-code}\nfor (i in seq_along(districts)) {\n  test_district <- districts[i]\n\n  train_data <- fishnet_model %>% filter(District != test_district)\n  test_data  <- fishnet_model %>% filter(District == test_district)\n\n  model_cv <- glm.nb(countSanitation ~ nn_meanDist + dist_to_hotspot, data = train_data)\n\n  test_data <- test_data %>%\n    mutate(prediction = predict(model_cv, newdata = test_data, type = \"response\"))\n\n  mae  <- mean(abs(test_data$countSanitation - test_data$prediction))\n  rmse <- sqrt(mean((test_data$countSanitation - test_data$prediction)^2))\n\n  cv_results <- bind_rows(cv_results, tibble(\n    fold = i,\n    test_district = test_district,\n    n_test = nrow(test_data),\n    MAE = mae,\n    RMSE = rmse\n  ))\n\n  cat(\"  Fold\", i, \"/\", length(districts), \n      \"- District\", test_district, \n      \"- MAE:\", round(mae, 2), \n      \"- RMSE:\", round(rmse, 2), \"\\n\")\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Fold 1 / 22 - District 5 - MAE: 2.65 - RMSE: 4.38 \n  Fold 2 / 22 - District 4 - MAE: 2.11 - RMSE: 11.91 \n  Fold 3 / 22 - District 22 - MAE: 3.28 - RMSE: 5.82 \n  Fold 4 / 22 - District 6 - MAE: 6.08 - RMSE: 8.25 \n  Fold 5 / 22 - District 8 - MAE: 3.44 - RMSE: 8.04 \n  Fold 6 / 22 - District 7 - MAE: 5.71 - RMSE: 7.96 \n  Fold 7 / 22 - District 3 - MAE: 4.51 - RMSE: 6.55 \n  Fold 8 / 22 - District 2 - MAE: 4.24 - RMSE: 6.27 \n  Fold 9 / 22 - District 9 - MAE: 2.95 - RMSE: 4.79 \n  Fold 10 / 22 - District 10 - MAE: 4.35 - RMSE: 6.02 \n  Fold 11 / 22 - District 1 - MAE: 2.63 - RMSE: 4.74 \n  Fold 12 / 22 - District 12 - MAE: 3.73 - RMSE: 5.1 \n  Fold 13 / 22 - District 15 - MAE: 5 - RMSE: 7.3 \n  Fold 14 / 22 - District 11 - MAE: 6.35 - RMSE: 8.56 \n  Fold 15 / 22 - District 18 - MAE: 6.4 - RMSE: 10.05 \n  Fold 16 / 22 - District 25 - MAE: 4.98 - RMSE: 7.07 \n  Fold 17 / 22 - District 14 - MAE: 7.81 - RMSE: 10.46 \n  Fold 18 / 22 - District 19 - MAE: 7.55 - RMSE: 10.51 \n  Fold 19 / 22 - District 16 - MAE: 1.89 - RMSE: 2.87 \n  Fold 20 / 22 - District 17 - MAE: 6.35 - RMSE: 16.21 \n  Fold 21 / 22 - District 20 - MAE: 4.79 - RMSE: 7.62 \n  Fold 22 / 22 - District 24 - MAE: 5.97 - RMSE: 9.85 \n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncat(\"\\nLOGO Cross-Validation complete\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nLOGO Cross-Validation complete\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Mean MAE :\", round(mean(cv_results$MAE), 2), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nMean MAE : 4.67 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Mean RMSE:\", round(mean(cv_results$RMSE), 2), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nMean RMSE: 7.74 \n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncv_results %>%\n  arrange(desc(MAE)) %>%\n  kable(\n    digits = 2,\n    caption = \"Leave-One-District-Out Cross-Validation Results\"\n  ) %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\"))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"margin-left: auto; margin-right: auto;\">\n<caption>Leave-One-District-Out Cross-Validation Results</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> fold </th>\n   <th style=\"text-align:left;\"> test_district </th>\n   <th style=\"text-align:right;\"> n_test </th>\n   <th style=\"text-align:right;\"> MAE </th>\n   <th style=\"text-align:right;\"> RMSE </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 17 </td>\n   <td style=\"text-align:left;\"> 14 </td>\n   <td style=\"text-align:right;\"> 46 </td>\n   <td style=\"text-align:right;\"> 7.81 </td>\n   <td style=\"text-align:right;\"> 10.46 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 18 </td>\n   <td style=\"text-align:left;\"> 19 </td>\n   <td style=\"text-align:right;\"> 63 </td>\n   <td style=\"text-align:right;\"> 7.55 </td>\n   <td style=\"text-align:right;\"> 10.51 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 15 </td>\n   <td style=\"text-align:left;\"> 18 </td>\n   <td style=\"text-align:right;\"> 30 </td>\n   <td style=\"text-align:right;\"> 6.40 </td>\n   <td style=\"text-align:right;\"> 10.05 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 20 </td>\n   <td style=\"text-align:left;\"> 17 </td>\n   <td style=\"text-align:right;\"> 82 </td>\n   <td style=\"text-align:right;\"> 6.35 </td>\n   <td style=\"text-align:right;\"> 16.21 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 14 </td>\n   <td style=\"text-align:left;\"> 11 </td>\n   <td style=\"text-align:right;\"> 43 </td>\n   <td style=\"text-align:right;\"> 6.35 </td>\n   <td style=\"text-align:right;\"> 8.56 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 4 </td>\n   <td style=\"text-align:left;\"> 6 </td>\n   <td style=\"text-align:right;\"> 63 </td>\n   <td style=\"text-align:right;\"> 6.08 </td>\n   <td style=\"text-align:right;\"> 8.25 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 22 </td>\n   <td style=\"text-align:left;\"> 24 </td>\n   <td style=\"text-align:right;\"> 41 </td>\n   <td style=\"text-align:right;\"> 5.97 </td>\n   <td style=\"text-align:right;\"> 9.85 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 6 </td>\n   <td style=\"text-align:left;\"> 7 </td>\n   <td style=\"text-align:right;\"> 52 </td>\n   <td style=\"text-align:right;\"> 5.71 </td>\n   <td style=\"text-align:right;\"> 7.96 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 13 </td>\n   <td style=\"text-align:left;\"> 15 </td>\n   <td style=\"text-align:right;\"> 32 </td>\n   <td style=\"text-align:right;\"> 5.00 </td>\n   <td style=\"text-align:right;\"> 7.30 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 16 </td>\n   <td style=\"text-align:left;\"> 25 </td>\n   <td style=\"text-align:right;\"> 85 </td>\n   <td style=\"text-align:right;\"> 4.98 </td>\n   <td style=\"text-align:right;\"> 7.07 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 21 </td>\n   <td style=\"text-align:left;\"> 20 </td>\n   <td style=\"text-align:right;\"> 30 </td>\n   <td style=\"text-align:right;\"> 4.79 </td>\n   <td style=\"text-align:right;\"> 7.62 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 7 </td>\n   <td style=\"text-align:left;\"> 3 </td>\n   <td style=\"text-align:right;\"> 43 </td>\n   <td style=\"text-align:right;\"> 4.51 </td>\n   <td style=\"text-align:right;\"> 6.55 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 10 </td>\n   <td style=\"text-align:left;\"> 10 </td>\n   <td style=\"text-align:right;\"> 63 </td>\n   <td style=\"text-align:right;\"> 4.35 </td>\n   <td style=\"text-align:right;\"> 6.02 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 8 </td>\n   <td style=\"text-align:left;\"> 2 </td>\n   <td style=\"text-align:right;\"> 56 </td>\n   <td style=\"text-align:right;\"> 4.24 </td>\n   <td style=\"text-align:right;\"> 6.27 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 12 </td>\n   <td style=\"text-align:left;\"> 12 </td>\n   <td style=\"text-align:right;\"> 73 </td>\n   <td style=\"text-align:right;\"> 3.73 </td>\n   <td style=\"text-align:right;\"> 5.10 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 5 </td>\n   <td style=\"text-align:left;\"> 8 </td>\n   <td style=\"text-align:right;\"> 197 </td>\n   <td style=\"text-align:right;\"> 3.44 </td>\n   <td style=\"text-align:right;\"> 8.04 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:left;\"> 22 </td>\n   <td style=\"text-align:right;\"> 112 </td>\n   <td style=\"text-align:right;\"> 3.28 </td>\n   <td style=\"text-align:right;\"> 5.82 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 9 </td>\n   <td style=\"text-align:left;\"> 9 </td>\n   <td style=\"text-align:right;\"> 107 </td>\n   <td style=\"text-align:right;\"> 2.95 </td>\n   <td style=\"text-align:right;\"> 4.79 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> 5 </td>\n   <td style=\"text-align:right;\"> 98 </td>\n   <td style=\"text-align:right;\"> 2.65 </td>\n   <td style=\"text-align:right;\"> 4.38 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 11 </td>\n   <td style=\"text-align:left;\"> 1 </td>\n   <td style=\"text-align:right;\"> 28 </td>\n   <td style=\"text-align:right;\"> 2.63 </td>\n   <td style=\"text-align:right;\"> 4.74 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:left;\"> 4 </td>\n   <td style=\"text-align:right;\"> 235 </td>\n   <td style=\"text-align:right;\"> 2.11 </td>\n   <td style=\"text-align:right;\"> 11.91 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 19 </td>\n   <td style=\"text-align:left;\"> 16 </td>\n   <td style=\"text-align:right;\"> 129 </td>\n   <td style=\"text-align:right;\"> 1.89 </td>\n   <td style=\"text-align:right;\"> 2.87 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nTo evaluate the spatial generalization of the model, a Leave-One-District-Out (LOGO) cross-validation was implemented using Chicago’s 22 police districts as spatial groups. In each fold, one district was held out for testing while the Negative Binomial model was trained on the remaining districts.\n\nAcross all 22 folds, the model achieved an average Mean Absolute Error (MAE) of 4.67 and a Root Mean Squared Error (RMSE) of 7.74. These results indicate that the model performs reasonably well in predicting sanitation code violation counts for spatially unseen districts. Errors tend to be larger in central and high-density districts, reflecting the underlying spatial heterogeneity of urban sanitation violations.\n\nOverall, the LOGO cross-validation confirms that the model captures meaningful spatial patterns and maintains moderate predictive accuracy across the city.\n\n#### Part 6: Model Evaluation\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfishnet_model$pred_2017 <- predict(model_nb, newdata = fishnet_model, type = \"response\")\n\ncat(\"Generated in-sample predictions for 2017\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nGenerated in-sample predictions for 2017\n```\n\n\n:::\n\n```{.r .cell-code}\nsanitation_2018 <- read_csv(\"data/Sanitation.csv\") %>%\n  mutate(CreationDate = mdy(`Creation Date`),\n         Year = year(CreationDate)) %>%\n  filter(Year == 2018,\n         !is.na(Latitude), !is.na(Longitude)) %>%\n  st_as_sf(coords = c(\"Longitude\", \"Latitude\"), crs = 4326) %>%\n  st_transform('ESRI:102271')\n\ncat(\"Loaded 2018 sanitation records:\", nrow(sanitation_2018), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nLoaded 2018 sanitation records: 18023 \n```\n\n\n:::\n\n```{.r .cell-code}\nfishnet_2018 <- st_join(fishnet, sanitation_2018, join = st_contains) %>%\n  group_by(uniqueID) %>%\n  summarise(count2018 = n()) %>%\n  right_join(fishnet_model, by = \"uniqueID\") %>%\n  mutate(count2018 = ifelse(is.na(count2018), 0, count2018))\n\ncat(\"Aggregated 2018 counts to fishnet grid\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nAggregated 2018 counts to fishnet grid\n```\n\n\n:::\n\n```{.r .cell-code}\nfishnet_2018$pred_2018 <- predict(model_nb, newdata = fishnet_2018, type = \"response\")\n\nfishnet_2018 <- fishnet_2018 %>%\n  mutate(error = count2018 - pred_2018)\n\nmae_2018 <- mean(abs(fishnet_2018$error))\nrmse_2018 <- sqrt(mean((fishnet_2018$error)^2))\n\ncat(\"2018 Temporal Validation complete\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n2018 Temporal Validation complete\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"MAE (2018):\", round(mae_2018, 2), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nMAE (2018): 5.05 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"RMSE (2018):\", round(rmse_2018, 2), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRMSE (2018): 7.84 \n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npoints2017 <- sanitation_sf %>%\n  st_coordinates() %>%\n  as.data.frame()\n\nkde_2017 <- spatstat.geom::ppp(points2017$X, points2017$Y,\n                               window = spatstat.geom::as.owin(st_union(chicagoBoundary)))\n\nkde_density <- spatstat.explore::density.ppp(kde_2017, sigma = 1000) # bandwidth 1km\n\nfishnet_2018$kde_pred <- raster::extract(raster::raster(kde_density), \n                                         st_coordinates(st_centroid(fishnet)))\n\nkde_mae  <- mean(abs(fishnet_2018$count2018 - fishnet_2018$kde_pred), na.rm = TRUE)\nkde_rmse <- sqrt(mean((fishnet_2018$count2018 - fishnet_2018$kde_pred)^2, na.rm = TRUE))\n\ncat(\"KDE baseline complete\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nKDE baseline complete\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"KDE MAE:\", round(kde_mae, 2), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nKDE MAE: 8.67 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"KDE RMSE:\", round(kde_rmse, 2), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nKDE RMSE: 12.55 \n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = chicagoBoundary, fill = \"gray95\", color = \"white\") +\n  geom_sf(data = fishnet_2018, aes(fill = error), color = NA) +\n  scale_fill_gradient2(\n    low = \"#2c7bb6\",\n    mid = \"white\",\n    high = \"#d7191c\",\n    midpoint = 0,\n    name = \"Prediction Error\"\n  ) +\n  labs(\n    title = \"Prediction Errors for 2018 (Observed - Predicted)\",\n    subtitle = \"Negative Binomial Model\",\n    caption = \"Blue = Overprediction, Red = Underprediction\"\n  ) +\n  theme_void() +\n  theme(\n    plot.title = element_text(face = \"bold\", size = 14),\n    plot.subtitle = element_text(color = \"gray40\")\n  )\n```\n\n::: {.cell-output-display}\n![](Luciano_Lu_assignment4_files/figure-html/unnamed-chunk-22-1.png){width=672}\n:::\n:::\n\n\nThe Negative Binomial model was trained on 2017 sanitation violations and then applied to predict 2018 counts at the 500 m grid level. Model predictions were compared against observed 2018 violations and against a kernel density estimation (KDE) baseline.\n\nPredictive accuracy (temporal validation): The model achieved MAE = 5.05 and RMSE = 7.84, substantially lower than the KDE baseline (MAE = 8.67, RMSE = 12.55). This indicates the regression model generalizes well across time and captures spatial drivers of violation occurrence that simple hotspot persistence (KDE) cannot.\n\nSpatial pattern of errors (map): The map of 2018 prediction errors shows:\n\nBlue cells (over-prediction): areas where the model predicted more violations than actually occurred—often along the southern and western edges of Chicago.\n\nRed cells (under-prediction): locations where observed violations exceeded predictions, mainly clustered in older central neighborhoods. This spatial structure suggests that some unmodeled factors—such as local inspection policies or demographic changes—still influence violation frequency.\n\nOverall assessment: The Negative Binomial model improves predictive performance over both Poisson and KDE approaches. It handles overdispersion and learns spatial correlates of sanitation activity, making it more robust for forecasting future 311 requests.\n\n#### CHALLENGE TASK: Temporal Validation (2018)\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncrime_2018 <- read_csv(\"https://data.cityofchicago.org/resource/3i3m-jwuy.csv\")\n\ncrime_2018_burg <- crime_2018 %>%\n  filter(primary_type == \"BURGLARY\",\n         description == \"FORCIBLE ENTRY\",\n         !is.na(longitude), !is.na(latitude)) %>%\n  mutate(year = year(as_date(date)))\n\ncat(\"2018 burglary (FORCIBLE ENTRY) incidents:\", \n    nrow(crime_2018_burg), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n2018 burglary (FORCIBLE ENTRY) incidents: 26 \n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncrime_2018_sf <- st_as_sf(\n  crime_2018_burg,\n  coords = c(\"longitude\", \"latitude\"),\n  crs = 4326\n) %>%\n  st_transform(st_crs(fishnet))\n\ncounts_crime_2018 <- st_join(fishnet, crime_2018_sf, join = st_contains) %>%\n  st_drop_geometry() %>%\n  count(uniqueID, name = \"countCrime2018\")\n\nfishnet_crime_2018 <- fishnet %>%\n  left_join(counts_crime_2018, by = \"uniqueID\") %>%\n  mutate(countCrime2018 = replace_na(countCrime2018, 0))\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfishnet_crime_2018$predCrime <- predict(\n  model_nb,\n  newdata = fishnet_crime_2018 %>% st_drop_geometry(),\n  type = \"response\"\n)\n\nfishnet_crime_2018 <- fishnet_crime_2018 %>%\n  mutate(error = countCrime2018 - predCrime)\n\nmae_crime <- mean(abs(fishnet_crime_2018$error))\nrmse_crime <- sqrt(mean((fishnet_crime_2018$error)^2))\n\ncat(\"2018 Burglary Temporal Validation → MAE:\", round(mae_crime, 2),\n    \" RMSE:\", round(rmse_crime, 2), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n2018 Burglary Temporal Validation → MAE: 8.58  RMSE: 11.72 \n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = chicagoBoundary, fill = \"gray95\", color = \"white\") +\n  geom_sf(data = fishnet_crime_2018, aes(fill = error), color = NA) +\n  scale_fill_gradient2(low = \"#2c7bb6\", mid = \"white\", high = \"#d7191c\",\n                       midpoint = 0, name = \"Error (Obs - Pred)\") +\n  labs(title = \"2018 Burglary (FORCIBLE ENTRY) Prediction Errors\",\n       subtitle = \"Predicted using 2017 Sanitation Model\",\n       caption = \"Blue = Overprediction, Red = Underprediction\") +\n  theme_void() +\n  theme(\n    plot.title = element_text(face = \"bold\", size = 14),\n    plot.subtitle = element_text(color = \"gray40\")\n  )\n```\n\n::: {.cell-output-display}\n![](Luciano_Lu_assignment4_files/figure-html/unnamed-chunk-26-1.png){width=672}\n:::\n:::\n\n\nThe 2018 burglary prediction errors show systematic overprediction (predicted counts higher than observed), indicating limited transferability of the sanitation-based model to crime patterns. Moreover, the Poisson model was found to be overdispersed (variance ≫ mean), justifying the use of a Negative Binomial specification, which effectively reweights the variance structure to better model spatially heterogeneous count data.\n\n## Step 3: Analysis\n\n### Overview\n\nThis project builds a spatial predictive model of sanitation-related 311 service requests in Chicago for 2017–2018. Using a 500 m × 500 m fishnet grid as the spatial unit, the analysis combines descriptive mapping, spatial autocorrelation diagnostics, and count regression models to understand and predict the geographic distribution of sanitation code violations.\n\nSpatial clustering and model diagnostics show that these urban service complaints are not randomly distributed. Instead, they exhibit strong spatial dependence—particularly along the South and West Sides—reflecting the persistence of neighborhood-level environmental and socioeconomic inequalities.\n\n------------------------------------------------------------------------\n\n### 1. Spatial Clustering\n\nExploratory mapping revealed clear spatial concentrations of sanitation violations. Local Moran’s I confirmed statistically significant **High-High clusters** (hotspots) in central-west and south-side neighborhoods, while **Low-Low clusters** occurred in more peripheral or affluent areas.\\\nThis indicates that sanitation complaints follow patterns of older housing stock, population turnover, and varying municipal service responsiveness.\n\n------------------------------------------------------------------------\n\n### 2. Count Regression Modeling\n\nBoth Poisson and Negative Binomial (NB) count models were fit to predict the number of violations per grid cell using two spatial covariates:\n\n-   **Mean distance to nearest 3 sanitation events (nn_meanDist)**\n-   **Distance to the nearest high-high cluster centroid (dist_to_hotspot)**\n\nThe Poisson model exhibited **overdispersion** (dispersion = 4.54 ≫ 1.5), meaning that the variance of counts greatly exceeded the mean.\\\nThe NB model corrected this issue and achieved a much better fit (AIC = 11 212 vs 14 422 for Poisson), validating the choice of a variance-adjusted count specification.\\\nBoth predictors were significantly negative, showing that proximity to existing violations and hotspots strongly increases expected complaint frequency.\n\n------------------------------------------------------------------------\n\n### 3. Spatial Cross-Validation (2017)\n\nA **Leave-One-District-Out (LOGO)** cross-validation using Chicago’s 22 police districts assessed spatial generalizability.\\\nThe model achieved **Mean MAE = 4.67** and **Mean RMSE = 7.74**, confirming moderate predictive power in unseen areas.\\\nPrediction errors were larger in dense downtown and inner-south districts, highlighting the spatial heterogeneity of urban sanitation behavior.\n\n------------------------------------------------------------------------\n\n### 4. Temporal Validation (2018)\n\nApplying the 2017 NB model to 2018 sanitation data yielded **MAE = 5.05** and **RMSE = 7.84**, outperforming a non-parametric **KDE baseline** (MAE = 8.67, RMSE = 12.55).\\\nThe model successfully generalized across years, indicating that neighborhood-level structural factors—rather than year-specific policy noise—drive much of the spatial pattern in 311 sanitation requests.\n\nThe 2018 error map showed: - **Blue areas (overprediction)** around southern and western peripheries\\\n- **Red areas (underprediction)** concentrated in inner neighborhoods where new complaints emerged in 2018\n\nThese differences likely stem from unmodeled local dynamics such as inspection intensity, redevelopment, or seasonal population change.\n\n------------------------------------------------------------------------\n\n### 5. Challenge Task: Cross-Domain Validation (2018 Burglary)\n\nThe 2017 sanitation model was tested on **2018 burglary (forcible entry)** events to evaluate cross-domain transferability.\\\nResults showed systematic **overprediction** across most grid cells, meaning that the model assumed crime would occur with similar spatial intensity as sanitation violations.\\\nThis demonstrates that while spatial autocorrelation structures are similar across urban phenomena, the underlying generative mechanisms (social, behavioral, or policing factors) differ substantially.\n\nSuch overprediction underscores the **domain specificity** of spatial count processes and the importance of incorporating domain-relevant variables when extending predictive models to new phenomena.\n\n------------------------------------------------------------------------\n\n### 6. Interpretation\n\n1.  **Spatial dependence matters:** Incorporating local spatial features (e.g., nearest-neighbor distances) substantially improves prediction over simple density persistence models.\\\n2.  **Overdispersion is the rule, not the exception:** Urban event counts rarely meet Poisson variance assumptions; the Negative Binomial model offers a practical correction by weighting variance heterogeneity.\\\n3.  **Temporal generalization is feasible:** Structural neighborhood effects remain stable across years.\\\n4.  **Cross-domain generalization is limited:** Models trained on sanitation data poorly capture crime patterns, revealing that social drivers differ even when spatial clustering appears similar.\n\n------------------------------------------------------------------------\n\nSpatially explicit predictive modeling of 311 sanitation complaints can help city agencies prioritize inspection and maintenance resources more efficiently.\\\nHowever, models must remain adaptive—incorporating updated data, temporal shifts, and behavioral heterogeneity—to avoid reinforcing historical inequalities in service delivery.\\\nFor broader urban analytics, this exercise shows both the potential and the limits of spatial transfer learning in complex social environments.\n",
    "supporting": [
      "Luciano_Lu_assignment4_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}